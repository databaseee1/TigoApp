<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - TigoHost</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Firebase SDK -->
<script type="module">
import { 
  initializeApp 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";


import { 
  getFirestore, collection, onSnapshot, doc, setDoc, updateDoc, getDoc, query, orderBy, getDocs, addDoc, deleteDoc, serverTimestamp, where
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";







// --- Firebase config ---
const firebaseConfig = {
  apiKey: "AIzaSy....",
  authDomain: "users-96dc5.firebaseapp.com",
  projectId: "users-96dc5",
  storageBucket: "users-96dc5.appspot.com",
  messagingSenderId: "483322415863",
  appId: "1:483322415863:web:xxxxxx"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ‚úÖ Ambil tabel deposit
const depositTable = document.getElementById("deposit-table");

// ‚úÖ Load data deposit (real-time)
function loadDepositData() {
  let depositRef;
  try {
    depositRef = query(collection(db, "deposit"), orderBy("createdAt", "desc"));
  } catch (err) {
    console.warn("OrderBy gagal, fallback tanpa sort");
    depositRef = collection(db, "deposit");
  }

  onSnapshot(depositRef, (snapshot) => {
    depositTable.innerHTML = ""; // Kosongkan tabel sebelum render ulang

    snapshot.forEach(docSnap => {
      const d = docSnap.data();
      const id = docSnap.id;

      // Buat baris
      const tr = document.createElement("tr");

      // Kolom Nama
      const td1 = document.createElement("td");
      td1.textContent = d.namaPengirim || '-';
      tr.appendChild(td1);

      // Kolom Bank
      const td2 = document.createElement("td");
      td2.textContent = d.bank || '-';
      tr.appendChild(td2);

      // Kolom Nominal
      const td3 = document.createElement("td");
      td3.textContent = `Rp ${(d.nominal || 0).toLocaleString()}`;
      tr.appendChild(td3);

      // Kolom Status
      const td4 = document.createElement("td");
      td4.style.color = d.status === 'pending' ? 'orange' : (d.status === 'approved' ? 'green' : 'red');
      td4.textContent = d.status || '-';
      tr.appendChild(td4);

      // Kolom Aksi
      const td5 = document.createElement("td");

      // Tombol Approve
      const approveBtn = document.createElement("button");
      approveBtn.classList.add("approve-btn");
      approveBtn.dataset.id = id;
      approveBtn.dataset.user = d.userId;
      approveBtn.dataset.nominal = d.nominal || 0;
      approveBtn.textContent = "Approve";
      if (d.status !== 'pending') approveBtn.disabled = true;

      // Tombol Tolak
      const rejectBtn = document.createElement("button");
      rejectBtn.classList.add("reject-btn");
      rejectBtn.dataset.id = id;
      rejectBtn.textContent = "Tolak";
      if (d.status !== 'pending') rejectBtn.disabled = true;

      // Tombol Tambah Saldo
      const addSaldoBtn = document.createElement("button");
      addSaldoBtn.classList.add("add-saldo-btn");
      addSaldoBtn.dataset.user = d.userId;
      addSaldoBtn.textContent = "Tambahkan";

      // Tombol Kurangi Saldo
      const kurangiSaldoBtn = document.createElement("button");
      kurangiSaldoBtn.classList.add("kurangi-saldo-btn");
      kurangiSaldoBtn.dataset.user = d.userId;
      kurangiSaldoBtn.textContent = "Kurangi";

      // Masukkan semua tombol ke kolom aksi
      td5.appendChild(approveBtn);
      td5.appendChild(rejectBtn);
      td5.appendChild(addSaldoBtn);
      td5.appendChild(kurangiSaldoBtn);

      tr.appendChild(td5);

      // Tambahkan baris ke tabel
      depositTable.appendChild(tr);
    });

    // Tambahkan event listener setelah data dimuat
    addDepositActionListeners();
  });
}

// ‚úÖ Event Listener untuk tombol aksi
function addDepositActionListeners() {
  // Approve
  document.querySelectorAll(".approve-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const depositId = btn.dataset.id;
      const userId = btn.dataset.user;
      const nominal = parseInt(btn.dataset.nominal);

      try {
        await updateDoc(doc(db, "deposit", depositId), { status: "approved" });

        const userRef = doc(db, "pendaftaran", userId);
        const userSnap = await getDoc(userRef);

        if (userSnap.exists()) {
          const userData = userSnap.data();
          const saldoRupiah = userData.saldoRupiah || 0;
          const saldoBaru = saldoRupiah + nominal;

          await updateDoc(userRef, { saldoRupiah: saldoBaru });
        }

        alert("‚úÖ Deposit berhasil di-approve dan saldo Rupiah bertambah!");
      } catch (error) {
        console.error("Gagal approve deposit:", error);
        alert("‚ùå Terjadi kesalahan saat approve deposit");
      }
    });
  });

  // Reject
  document.querySelectorAll(".reject-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const depositId = btn.dataset.id;
      await updateDoc(doc(db, "deposit", depositId), { status: "rejected" });
      alert("Deposit ditolak!");
    });
  });

  // Tambahkan Saldo
  document.querySelectorAll(".add-saldo-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const userId = btn.dataset.user;
      const amountToAdd = prompt("Masukkan jumlah saldo yang ingin ditambahkan:");

      if (isNaN(amountToAdd) || amountToAdd <= 0) {
        alert("Jumlah saldo tidak valid!");
        return;
      }

      try {
        const userRef = doc(db, "pendaftaran", userId);
        const userSnap = await getDoc(userRef);

        if (userSnap.exists()) {
          const userData = userSnap.data();
          const saldoRupiah = userData.saldoRupiah || 0;
          const newSaldo = saldoRupiah + parseInt(amountToAdd);

          await updateDoc(userRef, { saldoRupiah: newSaldo });
        }

        alert("Saldo berhasil ditambahkan!");
      } catch (error) {
        console.error("Gagal menambah saldo:", error);
        alert("‚ùå Terjadi kesalahan saat menambah saldo");
      }
    });
  });

  // Kurangi Saldo
  document.querySelectorAll(".kurangi-saldo-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const userId = btn.dataset.user;
      const amountToSubtract = prompt("Masukkan jumlah saldo yang ingin dikurangi:");

      if (isNaN(amountToSubtract) || amountToSubtract <= 0) {
        alert("Jumlah saldo tidak valid!");
        return;
      }

      try {
        const userRef = doc(db, "pendaftaran", userId);
        const userSnap = await getDoc(userRef);

        if (userSnap.exists()) {
          const userData = userSnap.data();
          const saldoRupiah = userData.saldoRupiah || 0;
          const newSaldo = saldoRupiah - parseInt(amountToSubtract);

          await updateDoc(userRef, { saldoRupiah: newSaldo });
        }

        alert("Saldo berhasil dikurangi!");
      } catch (error) {
        console.error("Gagal mengurangi saldo:", error);
        alert("‚ùå Terjadi kesalahan saat mengurangi saldo");
      }
    });
  });
}

// ‚úÖ Panggil ini hanya sekali saat halaman dimuat
loadDepositData();




// ===========================
// ‚úÖ Script Update Tagihan (Tambah bukan Replace)
// ===========================

const saveTagihanBtn = document.getElementById("saveTagihan");
const reduceTagihanBtn = document.getElementById("reduceTagihan");
const inputTagihan = document.getElementById("inputTagihan");

const configRef = doc(db, "settings", "config");

// ‚úÖ Tambah Tagihan
if (saveTagihanBtn) {
  saveTagihanBtn.addEventListener("click", async () => {
    await updateTagihan("tambah");
  });
}

// ‚úÖ Kurangi Tagihan
if (reduceTagihanBtn) {
  reduceTagihanBtn.addEventListener("click", async () => {
    await updateTagihan("kurangi");
  });
}

async function updateTagihan(action) {
  const nominalBaru = parseInt(inputTagihan.value);

  if (isNaN(nominalBaru) || nominalBaru <= 0) {
    alert("Masukkan jumlah tagihan yang valid!");
    return;
  }

  try {
    const configSnap = await getDoc(configRef);
    let currentTagihan = 0;

    if (configSnap.exists()) {
      currentTagihan = configSnap.data().jumlahTagihan || 0;
    }

    let newTagihan = currentTagihan;

    if (action === "tambah") {
      newTagihan += nominalBaru;
    } else if (action === "kurangi") {
      newTagihan -= nominalBaru;
      if (newTagihan < 0) newTagihan = 0; // ‚úÖ Pastikan tidak negatif
    }

    await setDoc(configRef, { jumlahTagihan: newTagihan }, { merge: true });

    alert(`Jumlah tagihan berhasil diupdate! Total sekarang: Rp ${newTagihan.toLocaleString()}`);
    inputTagihan.value = "";
  } catch (error) {
    console.error("Gagal update tagihan:", error);
    alert("Terjadi kesalahan!");
  }
}









document.addEventListener("DOMContentLoaded", () => {
  const dataUserTable = document.getElementById("data-user-table");
  const saldoUserTable = document.getElementById("saldo-user-table");
  const withdrawTable = document.getElementById("withdraw-user-table");
  const notifBox = document.getElementById("notif-box");

  const usersRef = collection(db, "pendaftaran");

  // ========================
  // üîπ Render User Data
  // ========================
  function renderUserRow(userId, data) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${data.nama || '-'}</td>
      <td>${data.umur || '-'}</td>
      <td>${data.jk || '-'}</td>
      <td>${data.wa || '-'}</td>
      <td>${data.email || '-'}</td>
      <td>${data.app || '-'}</td>
      <td>${data.bank || '-'}</td>
      <td>${data.namaRek || '-'}</td>
      <td>${data.noRek || '-'}</td>
      <td>${data.fotoURL ? `<img src="${data.fotoURL}" width="50">` : ''}</td>
      <td>
        ${data.verified 
          ? `<span style="color:green;font-weight:bold;">Diverifikasi</span>` 
          : `<span style="color:red;font-weight:bold;">Unverifikasi</span>`}
      </td>
      <td>
        <button class="verify-btn" data-id="${userId}" data-status="true">Verifikasi</button>
        <button class="verify-btn" data-id="${userId}" data-status="false">Batalkan</button>
      </td>
    `;
    dataUserTable.appendChild(tr);
  }

  // ========================
  // üîπ Render Saldo
  // ========================
  function renderSaldoRow(userId, data) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${data.nama || '-'}</td>
      <td>${data.email || '-'}</td>
      <td>Rp ${(data.saldo || 0).toLocaleString()}</td>
      <td>
        <select class="status-select">
          <option value="aktif" ${data.status=="aktif"?"selected":""}>Aktif</option>
          <option value="ditangguhkan" ${data.status=="ditangguhkan"?"selected":""}>Ditangguhkan</option>
          <option value="proses" ${data.status=="proses"?"selected":""}>Proses</option>
          <option value="ditolak" ${data.status=="ditolak"?"selected":""}>Ditolak</option>
          <option value="dihapus" ${data.status=="dihapus"?"selected":""}>Dihapus</option>
        </select>
      </td>
      <td>
        <button class="add-saldo">Tambah</button>
        <button class="kurangi-saldo">Kurangi</button>
      </td>
    `;
    saldoUserTable.appendChild(tr);

    // ‚úÖ Event tambah saldo
    tr.querySelector(".add-saldo").onclick = async () => {
      const val = parseInt(prompt("Masukkan jumlah tambah saldo:"));
      if (!isNaN(val) && val > 0) {
        await updateDoc(doc(db, "pendaftaran", userId), { saldo: (data.saldo || 0) + val });
      }
    };

    // ‚úÖ Event kurangi saldo
    tr.querySelector(".kurangi-saldo").onclick = async () => {
      const val = parseInt(prompt("Masukkan jumlah kurangi saldo:"));
      if (!isNaN(val) && val > 0) {
        await updateDoc(doc(db, "pendaftaran", userId), { saldo: (data.saldo || 0) - val });
      }
    };

    // ‚úÖ Event ubah status
    tr.querySelector(".status-select").onchange = async (e) => {
      await updateDoc(doc(db, "pendaftaran", userId), { status: e.target.value });
    };
  }

  // ========================
  // üîπ Render Withdraw
  // ========================
  function renderWithdrawRow(userId, data, item, index) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${data.nama || '-'}</td>
      <td>${data.email || '-'}</td>
      <td>${item.bank || '-'}</td>
      <td>${item.norek || '-'}</td>
      <td>${item.namarek || '-'}</td>
      <td>${item.jumlah || 0}</td>
      <td style="color:${item.color || 'black'}">${item.status}</td>
      <td>
        <button class="proses-btn">Proses</button>
        <button class="approve-btn">Approve</button>
        <button class="tolak-btn">Tolak</button>
        <button class="hapus-btn" style="background:red;color:white;">Hapus</button>
      </td>
    `;
    withdrawTable.appendChild(tr);

    // ‚úÖ Update status riwayat
    const updateStatus = async (newStatus, color) => {
      const userRef = doc(db, "pendaftaran", userId);
      const userSnap = await getDoc(userRef);
      const userData = userSnap.data() || {};
      const arr = Array.isArray(userData.riwayat) ? [...userData.riwayat] : [];
      arr[index] = { ...arr[index], status: newStatus, color };
      await updateDoc(userRef, { riwayat: arr });
    };

    // ‚úÖ Event tombol
    tr.querySelector(".proses-btn").onclick = () => updateStatus("Proses", "orange");
    tr.querySelector(".approve-btn").onclick = () => updateStatus("Approve", "green");

    tr.querySelector(".tolak-btn").onclick = async () => {
      const userRef = doc(db, "pendaftaran", userId);
      const userSnap = await getDoc(userRef);
      const userData = userSnap.data() || {};
      const arr = Array.isArray(userData.riwayat) ? [...userData.riwayat] : [];
      if (!arr[index]) return;
      const newSaldo = (userData.saldo || 0) + (arr[index].jumlah || 0);
      arr[index] = { ...arr[index], status: "Tolak", color: "red" };
      await updateDoc(userRef, { riwayat: arr, saldo: newSaldo });
    };

    tr.querySelector(".hapus-btn").onclick = async () => {
      if (!confirm("Yakin ingin menghapus riwayat withdraw ini?")) return;
      const userRef = doc(db, "pendaftaran", userId);
      const userSnap = await getDoc(userRef);
      const userData = userSnap.data() || {};
      let arr = Array.isArray(userData.riwayat) ? [...userData.riwayat] : [];
      arr.splice(index, 1);
      await updateDoc(userRef, { riwayat: arr });
      tr.remove();
    };
  }

  // ========================
  // üîπ Listener Firestore
  // ========================
  onSnapshot(query(usersRef, orderBy("createdAt", "desc")), (snapshot) => {
    dataUserTable.innerHTML = "";
    saldoUserTable.innerHTML = "";
    withdrawTable.innerHTML = "";

    snapshot.forEach((docSnap) => {
      const data = docSnap.data();
      const userId = docSnap.id;

      // ‚úÖ Pastikan user punya saldo & status
      if (data.saldo === undefined) {
        updateDoc(doc(db, "pendaftaran", userId), { saldo: 0, status: "aktif" });
      }

      // ‚úÖ Render tabel user & saldo
      renderUserRow(userId, data);
      renderSaldoRow(userId, data);

      // ‚úÖ Render withdraw
      const riwayat = Array.isArray(data.riwayat) ? data.riwayat : [];
      riwayat.forEach((item, index) => renderWithdrawRow(userId, data, item, index));

      // ‚úÖ Notif user baru
      const isNew = data.createdAt && (new Date() - data.createdAt.toDate()) < 24 * 60 * 60 * 1000;
      if (isNew) {
        notifBox.innerText = `üö® User baru mendaftar: ${data.nama || 'User Baru'}`;
        notifBox.style.display = "block";
        setTimeout(() => notifBox.style.display = "none", 5000);
      }
    });
  });

  // ========================
  // üîπ Event Verifikasi
  // ========================
  document.addEventListener("click", async (e) => {
    if (e.target.classList.contains("verify-btn")) {
      const userId = e.target.dataset.id;
      const status = e.target.dataset.status === "true";

      const konfirmasi = confirm(`Apakah Anda yakin ingin ${status ? 'memverifikasi' : 'membatalkan verifikasi'} user ini?`);
      if (!konfirmasi) return;

      try {
        await updateDoc(doc(db, "pendaftaran", userId), { verified: status });
        alert(`‚úÖ Status berhasil diubah menjadi ${status ? 'Diverifikasi' : 'Unverifikasi'}`);
      } catch (error) {
        console.error("Gagal ubah status:", error);
        alert("‚ùå Gagal mengubah status. Cek koneksi atau Firestore rules.");
      }
    }
  });
});



// ‚úÖ Load daftar user dari collection pendaftaran
async function loadUserList() {
  const userListEl = document.getElementById('userList');
  userListEl.innerHTML = '<p>Loading...</p>';

  const usersSnap = await getDocs(collection(db, 'pendaftaran'));
  let html = '';

  usersSnap.forEach(docSnap => {
    const data = docSnap.data();
    html += `
      <div style="border:1px solid #ccc; padding:10px; margin-bottom:8px; border-radius:6px; cursor:pointer;" 
        onclick="openSendMessagePopup('${docSnap.id}', '${data.nama || ''}', '${data.email || ''}', '${data.wa || ''}')">
        <strong>${data.nama || '-'}</strong><br>
        Email: ${data.email || '-'}<br>
        WA: ${data.wa || '-'}
      </div>
    `;
  });

  userListEl.innerHTML = html || '<p>Tidak ada user.</p>';
}

// ‚úÖ Buka popup kirim pesan
window.openSendMessagePopup = function(userId, nama, email, wa) {
  document.getElementById('sendMessagePopup').style.display = 'block';
  document.querySelector('#sendMessageForm input[name="userId"]').value = userId;
  document.querySelector('#sendMessagePopup h3').innerText = `Kirim Pesan ke ${nama}`;
  document.getElementById('chatInfo').innerHTML = `
    <p><strong>Nama:</strong> ${nama}</p>
    <p><strong>Email:</strong> ${email}</p>
    <p><strong>WA:</strong> ${wa}</p>
  `;
  loadChatHistory(userId);
};

// ‚úÖ Tutup popup kirim pesan
window.closeSendMessagePopup = function() {
  document.getElementById('sendMessagePopup').style.display = 'none';
};

// ‚úÖ Tutup popup CS
window.closeCsPopup = function() {
  document.getElementById('csPopup').style.display = 'none';
  document.getElementById('csOverlay').style.display = 'none';
};

// ‚úÖ Kirim pesan ke Firestore
document.getElementById('sendMessageForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const userId = this.userId.value;
  const pesan = this.message.value.trim();
  if (!pesan) return;

  await addDoc(collection(db, 'pesan'), {
    userId: userId,
    pesan: pesan,
    sender: 'admin', // ‚úÖ Tandai pengirim
    timestamp: serverTimestamp()
  });

  this.message.value = '';
});

// ‚úÖ Load riwayat chat user (REAL-TIME)
function loadChatHistory(userId) {
  const chatBox = document.getElementById('chatHistory');
  chatBox.innerHTML = '<p>Loading chat...</p>';

  const q = query(
    collection(db, 'pesan'),
    where('userId', '==', userId),
    orderBy('timestamp', 'asc')
  );

  // ‚úÖ Dengarkan perubahan data (real-time)
  onSnapshot(q, (snapshot) => {
    if (snapshot.empty) {
      chatBox.innerHTML = '<p>Belum ada pesan.</p>';
      return;
    }

    chatBox.innerHTML = ''; // Hapus konten lama

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const senderName = data.sender === 'admin' ? '<strong>Admin:</strong>' : '<strong>User:</strong>';

      // ‚úÖ Buat wrapper pesan
      const wrapper = document.createElement('div');
      wrapper.classList.add('chat-item');
      wrapper.setAttribute('data-id', docSnap.id);
      wrapper.style.display = 'flex';
      wrapper.style.alignItems = 'center';
      wrapper.style.marginBottom = '8px';

      // ‚úÖ Teks pesan
      const messageText = document.createElement('p');
      messageText.style.flex = '1';
      messageText.style.margin = '0';
      messageText.innerHTML = `${senderName} ${data.pesan}`;

      // ‚úÖ Ikon hapus
      const deleteIcon = document.createElement('img');
      deleteIcon.src = 'servant_icon.png';
      deleteIcon.alt = 'Hapus';
      deleteIcon.title = 'Hapus Pesan';
      deleteIcon.classList.add('delete-icon'); // CSS hover effect
      deleteIcon.style.width = '18px';
      deleteIcon.style.height = '18px';
      deleteIcon.style.cursor = 'pointer';
      deleteIcon.style.marginLeft = '8px';

      // ‚úÖ Tambahkan event hapus
      deleteIcon.addEventListener('click', () => deleteMessage(docSnap.id, wrapper));

      // ‚úÖ Gabungkan ke wrapper
      wrapper.appendChild(messageText);
      wrapper.appendChild(deleteIcon);

      chatBox.appendChild(wrapper);
    });

    // ‚úÖ Auto scroll ke bawah
    chatBox.scrollTop = chatBox.scrollHeight;
  });
}

// ‚úÖ Fungsi hapus pesan (SweetAlert konfirmasi)
async function deleteMessage(messageId, element) {
  const result = await Swal.fire({
    title: 'Yakin hapus pesan ini?',
    text: "Pesan akan dihapus permanen",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Ya, hapus!',
    cancelButtonText: 'Batal'
  });

  if (result.isConfirmed) {
    try {
      await deleteDoc(doc(db, 'pesan', messageId));
      element.style.transition = 'opacity 0.3s';
      element.style.opacity = '0';
      setTimeout(() => element.remove(), 300);
      Swal.fire('Berhasil!', 'Pesan sudah dihapus.', 'success');
    } catch (error) {
      console.error('Gagal menghapus pesan:', error);
      Swal.fire('Gagal!', 'Terjadi kesalahan saat menghapus.', 'error');
    }
  }
}

// ‚úÖ Buka popup CS (list user)
window.openCsPopup = function() {
  document.getElementById("csPopup").style.display = "block";
  document.getElementById("csOverlay").style.display = "block";
  loadUserList(); 
};







async function loadAnalisisForm() {
  const docRef = doc(db, "analisis", "data");
  const docSnap = await getDoc(docRef);

  if (docSnap.exists()) {
    const data = docSnap.data();
    document.getElementById('setPemasukan').value = data.pemasukan;
    document.getElementById('setPengeluaran').value = data.pengeluaran;
    document.getElementById('setUserBagus').value = data.userBagus;
    document.getElementById('setUserBuruk').value = data.userBuruk;
    document.getElementById('setPuas').value = data.totalPuas;
    document.getElementById('setTidakPuas').value = data.totalTidakPuas;
  }
}


function showPage(page) {
  document.querySelectorAll('[id^="ubah"], [id^="data"], [id^="saldo"], [id^="withdraw"], [id^="deposit"], [id^="updateTagihan"]').forEach(div => div.style.display = 'none');
  document.getElementById(page).style.display = 'block';

  if (page === 'ubahAnalisis') {
    loadAnalisisForm();
  }
}



document.getElementById('saveAnalisis').addEventListener('click', async () => {
  const data = {
    pemasukan: Number(document.getElementById('setPemasukan').value),
    pengeluaran: Number(document.getElementById('setPengeluaran').value),
    userBagus: Number(document.getElementById('setUserBagus').value),
    userBuruk: Number(document.getElementById('setUserBuruk').value),
    totalPuas: Number(document.getElementById('setPuas').value),
    totalTidakPuas: Number(document.getElementById('setTidakPuas').value)
  };

  try {
    await setDoc(doc(db, "analisis", "data"), data);
    Swal.fire('‚úÖ Berhasil!', 'Data analisis berhasil disimpan di Firebase.', 'success');
  } catch (error) {
    console.error("Gagal menyimpan data:", error);
    Swal.fire('‚ùå Gagal!', 'Terjadi kesalahan saat menyimpan data.', 'error');
  }
});



</script>

<style>
body {
  margin:0;
  font-family:Arial,sans-serif;
  background:#f5f6fa;
}

/* --- Sidebar --- */
.sidebar {
  width:220px;
  height:100vh;
  position:fixed;
  background:#2f3640;
  color:#fff;
  padding-top:20px;
  transition: transform 0.3s ease;
}
.sidebar h2 {text-align:center;margin-bottom:30px;}
.sidebar ul {list-style:none;padding:0;margin:0;}
.sidebar ul li {padding:15px 20px;cursor:pointer;transition:0.2s;}
.sidebar ul li:hover {background:#718093;}




 .delete-icon:hover {
    filter: brightness(0.8);
    transform: scale(1.1);
    transition: 0.2s;
  }
  #csPopup, #sendMessagePopup {
    display: none;
    position: fixed;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    background: #fff;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 999;
    width: 90%;
    max-width: 500px;
  }
  #csOverlay {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 998;
  }
  .chat-item {
    border-bottom: 1px solid #ddd;
    padding: 5px 0;
  }

.swal2-container {
  z-index: 2147483647 !important; /* Maksimum */
}


/* --- Main Content --- */
.main {
  margin-left:220px;
  padding:70px 20px 20px; /* top padding biar tidak ketimpa navbar */
  transition: margin-left 0.3s ease;
}

h1{margin-top:0; font-size: 15px;}
table {
  width:100%;
  border-collapse: collapse;
  background:#fff;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
}
table th, table td {
  padding:10px;
  border:1px solid #ddd;
  text-align:left;
  font-size:13px;
}
table th {
  background:#9500be;
  color: #ffffff;




#csOverlay {
    display:none;
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.5); z-index:999;
    pointer-events:none; /* Tambahkan ini supaya overlay tidak blok klik */
}


#dropdownMenu {
  display: none;
}
#dropdownMenu.show {
  display: block;
}






}
#notif-box {
  display:none;
  position: fixed;
  top:60px;
  right:20px;
  background: #08751a;
  color:#fff;
  padding:10px 20px;
  border-radius:5px;
  z-index:1000;
  font-size: 10px;
}
.page {display:none;}
.page.active {display:block;}
button {padding:4px 8px;     background: #834cff;
    color: #ffff;  margin-right:4px;cursor:pointer;}
.status-select {padding:4px;}

/* --- Top Navbar --- */
.topnav {
  top: 0;
  left: 220px; /* biar tidak nutup sidebar */
  right: 0;
  height: 50px;
  background: #2f3640;
  display: flex;
  align-items: center;
  padding: 0 0px;
  color: white;
  z-index: 1001;
}

.topnav .menu-btn {
  background: none;
  border: none;
  font-size: 20px;
  color: white;
  cursor: pointer;
}

.logo {
  display: flex;
  align-items: center;
  gap: 8px; /* jarak antara logo dan teks */
  font-weight: bold;
  font-size: 16px;
  color: white;
}

.logo img {
  height: 30px;
  width: 30px;
  object-fit: contain;
  border-radius: 15px;
}



.dropdown-content {
    display: none;
    position: absolute;
    right: 0;
    background: #fff;
    min-width: 160px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    border-radius: 6px;
    z-index: 1000;
  }

  .dropdown-content a {
    display: block;
    padding: 10px;
    color: #333;
    text-decoration: none;
  }

  .dropdown-content a:hover {
    background: #f0f0f0;
  }

  .dropdown-content.show {
    display: block;
  }




  
/* --- Responsive --- */
@media (max-width: 768px) {
  .sidebar {
    transform: translateX(-100%);
  }
  .sidebar.active {
    transform: translateX(0);
  }
  .main {
    margin-left:0;
    padding:10px 2px 200px;
    
  }
}


.approve-btn {
  background-color: #28a745; /* hijau */
  color: #fff;
  border: none;
  padding: 6px 12px;
  border-radius: 5px;
  cursor: pointer;
  transition: background 0.2s;
}

.approve-btn:hover {
  background-color: #218838; /* hijau lebih gelap saat hover */
}


.proses-btn {
  background-color: #ffc107; /* kuning */
  color: #000;  /* teks hitam agar kontras */
  border: none;
  padding: 6px 12px;
  border-radius: 5px;
  cursor: pointer;
  transition: background 0.2s;
}

.proses-btn:hover {
  background-color: #e0a800; /* kuning lebih gelap saat hover */
}


.tolak-btn {
  background-color: #c82333; /* merah tua */
  color: #fff; /* teks putih biar kontras */
  border: none;
  padding: 6px 12px;
  border-radius: 5px;
  cursor: pointer;
  transition: background 0.2s;
}

.tolak-btn:hover {
  background-color: #a71d2a; /* merah lebih gelap saat hover */
}


.add-saldo {
  background-color: #28a745; /* hijau */
  color: #fff; /* teks putih */
  border: none;
  padding: 6px 12px;
  border-radius: 5px;
  cursor: pointer;
  transition: background 0.2s;
}

.add-saldo:hover {
  background-color: #218838; /* hijau lebih gelap saat hover */
}

.kurangi-saldo {
  background-color: #dc3545; /* merah */
  color: #fff; /* teks putih */
  border: none;
  padding: 6px 12px;
  border-radius: 5px;
  cursor: pointer;
  transition: background 0.2s;
}

.kurangi-saldo:hover {
  background-color: #c82333; /* merah lebih gelap saat hover */
}


</style>
</head>
<body>

<!-- ‚úÖ NAVBAR -->
<div style="display:flex; justify-content:space-between; align-items:center; padding:10px; background:#7f3586; color:#fff;">
  <div style="display:flex; align-items:center; gap:10px;">
    <img src="agencylogo.png" alt="Logo" style="width:35px; height:35px; border-radius:50%;">
    <span style="font-weight:bold;">ADMIN CS</span>
    <img src="agencylogo.png" alt="CS" onclick="openCsPopup()" style="width:30px; height:30px; cursor:pointer;" onerror="this.src='https://via.placeholder.com/30'">
  </div>
  <div style="position:relative;">
  <button onclick="toggleDropdown()" style="background:#fff; color:#7f3586; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">‚öô Menu</button>
  <div id="dropdownMenu" class="dropdown-content">
    <a href="#" onclick="showPage('data')">Data User</a>
    <a href="#" onclick="showPage('saldo')">Saldo User</a>
    <a href="#" onclick="showPage('withdraw')">User Withdraw</a>
    <a href="#" onclick="showPage('deposit')">Deposit User</a>
    <a href="#" onclick="showPage('updateTagihan')">Update Tagihan</a>
    <a href="https://databaseee1.github.io/TigoApp/analisist%20data%20host/">Analisis Data</a>
    <a href="#" onclick="showPage('ubahAnalisis')">Ubah Analisis</a> <!-- üî• menu baru -->
  </div>
</div>
</div>


<div id="ubahAnalisis" style="display:none; padding:20px;">
  <h2>Ubah Analisis Data</h2>

  <label>Pemasukan: </label>
  <input type="number" id="setPemasukan"><br><br>

  <label>Pengeluaran: </label>
  <input type="number" id="setPengeluaran"><br><br>

  <label>User Bagus: </label>
  <input type="number" id="setUserBagus"><br><br>

  <label>User Buruk: </label>
  <input type="number" id="setUserBuruk"><br><br>

  <label>Total Puas: </label>
  <input type="number" id="setPuas"><br><br>

  <label>Total Tidak Puas: </label>
  <input type="number" id="setTidakPuas"><br><br>

  <button id="saveAnalisis" style="padding:10px 20px; background:#7f3586; color:#fff; border:none; border-radius:6px; cursor:pointer;">Simpan</button>
</div>




<!-- ‚úÖ Overlay -->
<div id="csOverlay" onclick="closeAllPopups()" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;"></div>

<!-- ‚úÖ Popup CS -->
<div id="csPopup" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; border-radius:10px; padding:20px; box-shadow:0 6px 12px rgba(0,0,0,0.2); z-index:10000; width:90%; max-width:500px;">
  <h3 style="text-align:center; color:#7f3586; margin-top:0;">Daftar User</h3>
  <div id="userList" style="max-height:300px; overflow-y:auto; margin-top:15px; border:1px solid #ddd; border-radius:6px; padding:5px;"></div>
  <button onclick="closeCsPopup()" style="background:#ccc; border:none; padding:10px; width:100%; margin-top:10px; border-radius:6px; cursor:pointer;">Tutup</button>
</div>

<!-- ‚úÖ Popup Kirim Pesan -->
<div id="sendMessagePopup" style="
  display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
  background:#fff; width:90%; max-width:400px; border-radius:10px; padding:20px;
  box-shadow:0 6px 12px rgba(0,0,0,0.2); z-index:10001;
">
  <h3 style="text-align:center; color:#7f3586;">Kirim Pesan</h3>
  <div id="chatInfo" style="margin-bottom:10px; font-size:14px; color:#333;"></div>
  <div id="chatHistory" style="max-height:150px; overflow-y:auto; border:1px solid #ccc; padding:8px; margin-bottom:10px; border-radius:6px;"></div>
  <form id="sendMessageForm">
    <input type="hidden" name="userId">
    <textarea name="message" placeholder="Tulis pesan..." required style="
      width:100%; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #ccc; height:100px;
    "></textarea>
    <button type="submit" style="
      background:#7f3586; color:#fff; padding:12px; border:none; border-radius:8px; width:100%; margin-top:10px;
    ">Kirim</button>
  </form>
  <button onclick="closeSendMessagePopup()" style="
    background:#ccc; border:none; padding:10px; width:100%; margin-top:10px; border-radius:6px;
  ">Batal</button>
</div>



<!-- Halaman Deposit -->
<div id="deposit" class="page" style="display:none;">
  <h1>Deposit User</h1>
  <table border="1" cellspacing="0" cellpadding="8" style="width:100%; border-collapse: collapse;">
    <thead>
      <tr>
        <th>Nama Pengirim</th>
        <th>Bank</th>
        <th>Nominal</th>
        <th>Status</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody id="deposit-table"></tbody>
  </table>
</div>




<div id="updateTagihan" class="page" style="display:none;">
  <h2>Update Jumlah Tagihan</h2>
  <input type="number" id="inputTagihan" placeholder="Masukkan nominal (Rp)">

  <div style="margin-top:10px;">
    <button id="saveTagihan" style="background:#4CAF50; color:#fff; padding:8px 12px; border:none; border-radius:5px; margin-right:5px;">Tambah Tagihan</button>
    <button id="reduceTagihan" style="background:#F44336; color:#fff; padding:8px 12px; border:none; border-radius:5px;">Kurangi Tagihan</button>
  </div>
</div>



<div class="main">
  <div id="notif-box"></div>

  <div id="saldo" class="page">
    <h1>Saldo User</h1>
    <table>
      <thead>
        <tr>
          <th>Nama</th>
          <th>Email</th>
          <th>Saldo</th>
          <th>Status</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="saldo-user-table"></tbody>
    </table>
  </div>

  <div id="data" class="page active">
    <h1>Data User</h1>
    <table>
<thead>
  <tr>
    <th>Nama</th>
    <th>Umur</th>
    <th>JK</th>
    <th>WA</th>
    <th>Email</th>
    <th>Aplikasi</th>
    <th>Bank</th>
    <th>Nama Rek</th>
    <th>No Rek</th>
    <th>Foto</th>
    <th>Status Verifikasi</th>
    <th>Aksi</th> 
  </tr>
</thead>
      <tbody id="data-user-table"></tbody>
    </table>
  </div>

  <div id="withdraw" class="page">
    <h1>User Withdraw</h1>
    <table>
      <thead>
        <tr>
          <th>Nama</th>
          <th>Email</th>
          <th>Bank</th>
          <th>No Rek</th>
          <th>Nama Rek</th>
          <th>Jumlah</th>
          <th>Status</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="withdraw-user-table"></tbody>
    </table>
  </div>
</div>

<script>
function toggleSidebar() {
  const sidebar = document.querySelector(".sidebar");
  if (sidebar) {
    sidebar.classList.toggle("active");
  }
}

function toggleDropdown() {
  const dropdown = document.getElementById("dropdownMenu");
  if (!dropdown) {
    console.error("Dropdown menu tidak ditemukan");
    return;
  }
  dropdown.classList.toggle("show");
}

// Klik di luar dropdown ‚Üí tutup otomatis
document.addEventListener("click", function (e) {
  const dropdown = document.getElementById("dropdownMenu");
  const button = e.target.closest("button");

  if (dropdown && !dropdown.contains(e.target) && !button) {
    dropdown.classList.remove("show");
  }
});

function showPage(pageId) {
  // Sembunyikan semua page
  document.querySelectorAll(".page").forEach(p => {
    p.style.display = "none";
    p.classList.remove("active");
  });

  // Tampilkan page yang dipilih
  const activePage = document.getElementById(pageId);
  if (activePage) {
    activePage.style.display = "block";
    activePage.classList.add("active");
  } else {
    console.error(`Halaman dengan ID "${pageId}" tidak ditemukan`);
  }

  // Auto close sidebar di mobile
  if (window.innerWidth <= 768) {
    const sidebar = document.querySelector(".sidebar");
    if (sidebar) sidebar.classList.remove("active");
  }
}



// Hapus akun (soft delete)
window.hapusUser = async function(userId) {
  const userRef = doc(db, "pendaftaran", userId);
  await updateDoc(userRef, { status: "dihapus" });
  alert("‚úÖ Akun berhasil dihapus (soft delete).");
};

// Pulihkan akun
window.pulihkanUser = async function(userId) {
  const userRef = doc(db, "pendaftaran", userId);
  await updateDoc(userRef, { status: "aktif" });
  alert("‚úÖ Akun berhasil dipulihkan.");
};


document.addEventListener("click", function (e) {
  const dropdown = document.getElementById("dropdownMenu");
  const button = e.target.closest("button");

  if (!dropdown.contains(e.target) && !button) {
    dropdown.classList.remove("show");
  }
});






</script>

</body>
</html>
