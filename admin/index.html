<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Admin Panel - TigoHost</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script type="module" src="/js/admin.js"></script>


<!-- Firebase SDK -->
<script type="module">
import { 
  initializeApp 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";


import { 
  getFirestore, collection, onSnapshot, doc, setDoc, updateDoc, getDoc, query, orderBy, getDocs, addDoc, deleteDoc, serverTimestamp, where
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";






// --- Firebase config ---
const firebaseConfig = {
  apiKey: "AIzaSy....",
  authDomain: "users-96dc5.firebaseapp.com",
  projectId: "users-96dc5",
  storageBucket: "users-96dc5.appspot.com",
  messagingSenderId: "483322415863",
  appId: "1:483322415863:web:xxxxxx"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);










// ---------- LOAD CHAT CONTROL ----------
window.loadChatControl = async function () {
  const tbody = document.getElementById("chatControlTable");
  tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Memuat...</td></tr>`;

  try {
    const snap = await getDocs(collection(db, "pendaftaran"));
    console.log("Jumlah dokumen:", snap.size);

    tbody.innerHTML = "";

    if (snap.empty) {
      tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Tidak ada data</td></tr>`;
      return;
    }

    snap.forEach((docSnap) => {
      const u = docSnap.data();
      const id = docSnap.id;
      const status = u.chatStatus === "closed" ? "closed" : "open";
      const tombol = status === "open" ? "Tutup" : "Buka";
      const next = status === "open" ? "closed" : "open";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${u.nama || "-"}</td>
        <td>${u.email || "-"}</td>
        <td>${u.wa || "-"}</td>
        <td id="chat-${id}">${status}</td>
        <td>
          <button onclick="toggleChat('${id}', '${next}')">${tombol}</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  } catch (e) {
    console.error("Error loadChatControl:", e);
    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:red;">Gagal memuat data</td></tr>`;
  }
};

// ---------- TOGGLE CHAT ----------
window.toggleChat = async function (userId, newStatus) {
  try {
    const userRef = doc(db, "pendaftaran", userId);
    await updateDoc(userRef, { chatStatus: newStatus });

    // update tampilan tabel
    const cell = document.getElementById(`chat-${userId}`);
    if (cell) cell.textContent = newStatus;

    // update tombol juga
    const btn = cell?.nextElementSibling?.querySelector("button");
    if (btn) {
      btn.textContent = newStatus === "open" ? "Tutup" : "Buka";
      btn.setAttribute("onclick", `toggleChat('${userId}', '${newStatus === "open" ? "closed" : "open"}')`);
    }

    Swal.fire({
      icon: "success",
      title: "Berhasil",
      text: `Chat user diubah ke: ${newStatus}`,
      timer: 1500,
      showConfirmButton: false,
    });
  } catch (err) {
    console.error("Gagal update chat status:", err);
    Swal.fire({ icon: "error", text: "Gagal update chat status!" });
  }
};








const userTable = document.getElementById("userTable");

// ‚úÖ Render tabel tagihan per user (realtime)
function loadUsersTagihan() {
  const q = collection(db, "pendaftaran");
  onSnapshot(q, (snap) => {
    userTable.innerHTML = "";
    if (snap.empty) {
      userTable.innerHTML = `<tr><td colspan="5" style="text-align:center;">Tidak ada user</td></tr>`;
      return;
    }

    snap.forEach((docSnap) => {
      const user = docSnap.data();
      const uid = docSnap.id;

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${user.namaRek || user.nama || "-"}</td>
        <td>${user.email || "-"}</td>
        <td>${user.wa || "-"}</td>
        <td id="tagihan-${uid}">Rp ${(user.jumlahTagihan || 0).toLocaleString("id-ID")}</td>
        <td>
          <input type="number" id="input-${uid}" placeholder="Nominal" style="width:100px; border-radius:10px;">
          <button id="btn-add-${uid}" onclick="updateTagihanUser('${uid}', 'tambah')">Tambah</button>
          <button id="btn-sub-${uid}" onclick="updateTagihanUser('${uid}', 'kurangi')">Kurangi</button>
        </td>
      `;
      userTable.appendChild(row);
    });
  });
}

// ‚úÖ Update tagihan per user (tambah/kurangi, tidak boleh minus)
async function updateTagihanUser(uid, action) {
  const inputEl = document.getElementById(`input-${uid}`);
  const addBtn  = document.getElementById(`btn-add-${uid}`);
  const subBtn  = document.getElementById(`btn-sub-${uid}`);

  const nominalBaru = parseInt(inputEl?.value, 10);

  if (isNaN(nominalBaru) || nominalBaru <= 0) {
    alert("Masukkan nominal yang valid!");
    return;
  }

  // disable tombol saat proses
  addBtn && (addBtn.disabled = true);
  subBtn && (subBtn.disabled = true);

  try {
    const userRef = doc(db, "pendaftaran", uid);
    const userSnap = await getDoc(userRef);

    let currentTagihan = 0;
    if (userSnap.exists()) {
      currentTagihan = userSnap.data().jumlahTagihan || 0;
    }

    const delta = action === "tambah" ? nominalBaru : -nominalBaru;
    const newTagihan = Math.max(currentTagihan + delta, 0); // clamp ke 0

    await updateDoc(userRef, { jumlahTagihan: newTagihan });

    inputEl.value = "";
    // optional: kasih feedback
    // Swal.fire({icon:"success", text:`Tagihan berhasil di${action === "tambah" ? "tambah" : "kurangi"}.`});
  } catch (err) {
    console.error("Gagal update tagihan:", err);
    alert("Terjadi kesalahan saat update tagihan!");
  } finally {
    addBtn && (addBtn.disabled = false);
    subBtn && (subBtn.disabled = false);
  }
}

// ‚¨áÔ∏è letakkan di bawah sini
window.updateTagihanUser = updateTagihanUser;
document.addEventListener("DOMContentLoaded", loadUsersTagihan);








// ==========================
// üîπ Load User Deposit (userdpo)
// ==========================


// ==========================
// üîπ Load User Deposit (userdpo)
// ==========================
function loadUserDpo() {
  const tbody = document.getElementById("userdpoTableBody");
  const grandTotalEl = document.getElementById("grandTotal");

  onSnapshot(collection(db, "pendaftaran"), async (usersSnap) => {
    tbody.innerHTML = "";
    let grandTotal = 0;

    if (usersSnap.empty) {
      tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;">Belum ada user.</td></tr>`;
      grandTotalEl.innerText = "";
      return;
    }

    const withDeposit = [];
    const noDeposit = [];

    for (const userDoc of usersSnap.docs) {
      const user = userDoc.data();
      const uid = userDoc.id;

      const nama = user.namaLengkap || user.nama || "-";
      const email = user.email || user.userEmail || "-";
      const wa = user.whatsapp || user.wa || "-";
      const userStatus = user.statusAkun || "active"; // konsisten pakai statusAkun

      const q = query(collection(db, "historydeposit"), where("uid", "==", uid));
      const depositsSnap = await getDocs(q);

      if (!depositsSnap.empty) {
        depositsSnap.forEach((depDoc) => {
          const data = depDoc.data();
          const nominal = Number(data.nominal || 0);
          grandTotal += nominal;

          withDeposit.push({ uid, nama, email, wa, userStatus, depId: depDoc.id, data });
        });
      } else {
        noDeposit.push({ uid, nama, email, wa, userStatus });
      }
    }

    withDeposit.sort((a, b) => {
      const tA = a.data.timestamp?.toDate ? a.data.timestamp.toDate().getTime() : 0;
      const tB = b.data.timestamp?.toDate ? b.data.timestamp.toDate().getTime() : 0;
      return tB - tA;
    });

    function renderUserStatus(status) {
      if (status === "suspended") return "<span style='color:black;font-weight:bold;'>Suspended</span>";
      if (status === "banned") return "<span style='color:red;font-weight:bold;'>Banned</span>";
      if (status === "deleted") return "<span style='color:gray;font-weight:bold;'>Deleted</span>";
      return "<span style='color:green;font-weight:bold;'>Active</span>";
    }

    // render user dengan deposit
    withDeposit.forEach(({ uid, nama, email, wa, userStatus, depId, data }) => {
      let statusColor = "";
      if (data.status === "approve") statusColor = "style='color:green;font-weight:bold;'";
      else if (data.status === "pending") statusColor = "style='color:orange;font-weight:bold;'";
      else if (data.status === "tolak") statusColor = "style='color:red;font-weight:bold;'";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${nama}</td>
        <td>${email}</td>
        <td>${wa}</td>
        <td>Rp ${Number(data.nominal || 0).toLocaleString("id-ID")}</td>
        <td>${data.timestamp?.toDate ? data.timestamp.toDate().toLocaleString("id-ID") : '-'}</td>
        <td ${statusColor}>${data.status || 'pending'}</td>
        <td>${renderUserStatus(userStatus)}</td>
        <td>
          <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:6px;">
            <button onclick="updateDepositStatus('${depId}','${uid}','${data.subId}','approve')" style="background:green;color:#fff;padding:5px;border:none;border-radius:5px;cursor:pointer;">Approve</button>
            <button onclick="updateDepositStatus('${depId}','${uid}','${data.subId}','pending')" style="background:orange;color:#fff;padding:5px;border:none;border-radius:5px;cursor:pointer;">Pending</button>
            <button onclick="updateDepositStatus('${depId}','${uid}','${data.subId}','tolak')" style="background:red;color:#fff;padding:5px;border:none;border-radius:5px;cursor:pointer;">Tolak</button>
            <button onclick="hapusDeposit('${depId}','${uid}','${data.subId}')" style="background:gray;color:#fff;padding:5px;border:none;border-radius:5px;cursor:pointer;">Hapus</button>

            <button onclick="updateUserStatus('${uid}','active')" style="background:#00a898;color:#fff;padding:5px;border:none;border-radius:5px;cursor:pointer;">Aktifkan</button>
            <button onclick="updateUserStatus('${uid}','suspended')" style="background:#000;color:#fff;padding:5px;border:none;border-radius:5px;cursor:pointer;">Suspend</button>
            <button onclick="updateUserStatus('${uid}','banned')" style="background:#66;color:#fff;padding:5px;border:none;border-radius:5px;cursor:pointer;">Maintenance</button>
            <button onclick="updateUserStatus('${uid}','deleted')" style="background:#c00;color:#fff;padding:5px;border:none;border-radius:5px;cursor:pointer;">Bann User</button>
          </div>
        </td>`;
      tbody.appendChild(tr);
    });

    // render user tanpa deposit
    noDeposit.forEach(({ uid, nama, email, wa, userStatus }) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${nama}</td>
        <td>${email}</td>
        <td>${wa}</td>
        <td>Rp 0</td>
        <td>-</td>
        <td style="color:gray;font-weight:bold;">Belum Request</td>
        <td>${renderUserStatus(userStatus)}</td>
        <td>
          <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:6px;">
            <button onclick="updateUserStatus('${uid}','active')" style="background:#00a898;color:#fff;padding:5px;border:none;border-radius:5px;cursor:pointer;">Aktifkan</button>
            <button onclick="updateUserStatus('${uid}','suspended')" style="background:#000;color:#fff;padding:5px;border:none;border-radius:5px;cursor:pointer;">Suspend</button>
            <button onclick="updateUserStatus('${uid}','banned')" style="background:#c00;color:#fff;padding:5px;border:none;border-radius:5px;cursor:pointer;">Abaikan</button>
            <button onclick="updateUserStatus('${uid}','deleted')" style="background:#666;color:#fff;padding:5px;border:none;border-radius:5px;cursor:pointer;">Bann</button>
          </div>
        </td>`;
      tbody.appendChild(tr);
    });

    grandTotalEl.innerText = "Total Semua Deposit: Rp " + grandTotal.toLocaleString("id-ID");
  });
}

// ==========================
// üîπ Update Status User
// ==========================
async function updateUserStatus(uid, status) {
  try {
    await updateDoc(doc(db, "pendaftaran", uid), { statusAkun: status });
    Swal.fire({ icon: "success", text: "Status akun diubah ke " + status });
  } catch (err) {
    console.error("Update user status error:", err);
    Swal.fire({ icon: "error", text: "Gagal update status akun." });
  }
}
window.updateUserStatus = updateUserStatus;







// ==========================
// üîπ Update Deposit Status (Sinkronisasi Global + Subkoleksi)
// ==========================
async function updateDepositStatus(globalId, uid, subId, newStatus) {
  try {
    const updates = [];

    // Update global collection (wajib, admin lihat dari sini)
    updates.push(updateDoc(doc(db, "historydeposit", globalId), {
      status: newStatus
    }));

    // Kalau ada subId, update juga subkoleksi user (supaya user panel ikut sinkron)
    if (uid && subId) {
      updates.push(updateDoc(doc(db, "pendaftaran", uid, "historydeposit", subId), {
        status: newStatus
      }));
    }

    await Promise.all(updates);

    Swal.fire({ icon: "success", text: "Status deposit diubah ke " + newStatus });
  } catch (err) {
    console.error("Update deposit error:", err);
    Swal.fire({ icon: "error", text: "Gagal update status deposit." });
  }
}
window.updateDepositStatus = updateDepositStatus;






// ==========================
// üîπ Hapus Deposit
// ==========================
async function hapusDeposit(globalId, uid, subId) {
  try {
    await deleteDoc(doc(db, "historydeposit", globalId));
    if (uid && subId) {
      await deleteDoc(doc(db, "pendaftaran", uid, "historydeposit", subId));
    }
    Swal.fire({ icon: "success", text: "Deposit berhasil dihapus" });
  } catch (err) {
    console.error("Hapus deposit error:", err);
    Swal.fire({ icon: "error", text: "Gagal hapus deposit." });
  }
}
window.hapusDeposit = hapusDeposit;

// ‚úÖ panggil saat halaman siap
document.addEventListener("DOMContentLoaded", () => {
  if (document.getElementById("userdpo")) loadUserDpo();
});

































 // Load user dari Firestore
  async function loadUsersCredit() {
    const tbody = document.getElementById("userCreditTable");
    tbody.innerHTML = "";
    const snap = await getDocs(collection(db, "pendaftaran"));

    snap.forEach(docSnap => {
      const data = docSnap.data();
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${data.namaRek || "-"}</td>
        <td>${data.email || "-"}</td>
        <td>${data.wa || "-"}</td>
        <td id="credit-${docSnap.id}">${data.saldoCredit || 0}</td>
        <td>
          <input type="number" id="amount-${docSnap.id}" placeholder="Jumlah" style="width:80px;">
          <button onclick="updateCredit('${docSnap.id}','add')">Tambah</button>
          <button onclick="updateCredit('${docSnap.id}','reduce')">Kurangi</button>
        </td>
      `;
      tbody.appendChild(row);
    });
  }

  // Update credit
  window.updateCredit = async function (userId, type) {
    const amountField = document.getElementById(`amount-${userId}`);
    const amount = parseInt(amountField.value);
    if (isNaN(amount) || amount <= 0) {
      alert("Masukkan jumlah valid!");
      return;
    }

    const userRef = doc(db, "pendaftaran", userId);
    const current = parseInt(document.getElementById(`credit-${userId}`).innerText);

    let newCredit = current;
    if (type === "add") {
      newCredit += amount;
    } else if (type === "reduce") {
      if (current < amount) {
        alert("Credit user tidak cukup!");
        return;
      }
      newCredit -= amount;
    }

    await updateDoc(userRef, { saldoCredit: newCredit });
    document.getElementById(`credit-${userId}`).innerText = newCredit;
    amountField.value = "";
    alert("Credit berhasil diupdate!");
  }

  // Dipanggil saat admin klik menu "Tambah Credit"
  window.openTambahCredit = function () {
    document.getElementById("tambahCreditSection").style.display = "block";
    loadUsersCredit();
  }





// ==========================
// üîπ Load Saldo Host (Auto urut terbaru di atas)
// ==========================
const saldoHostTable = document.getElementById("saldoHostTable").querySelector("tbody");

// ==========================
// üîπ Load Saldo Host Data
// ==========================
async function loadSaldoHostData() {
  const q = query(collection(db, "pendaftaran"));
  onSnapshot(q, (snapshot) => {
    const users = [];
    snapshot.forEach((docSnap) => {
      users.push({ id: docSnap.id, ...docSnap.data() });
    });

    // ‚úÖ Urutkan manual berdasarkan lastUpdated (yang baru diubah paling atas)
    users.sort((a, b) => {
      const tA = a.lastUpdated?.toMillis ? a.lastUpdated.toMillis() : 0;
      const tB = b.lastUpdated?.toMillis ? b.lastUpdated.toMillis() : 0;
      return tB - tA;
    });

    // ‚úÖ Render ke tabel
    saldoHostTable.innerHTML = "";
    users.forEach((d) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="padding:8px; border-bottom:1px solid #ddd;">${d.nama || "-"}</td>
        <td style="padding:8px; border-bottom:1px solid #ddd;">${d.email || "-"}</td>
        <td style="padding:8px; border-bottom:1px solid #ddd;">${d.wa || "-"}</td>
        <td style="padding:8px; border-bottom:1px solid #ddd; font-weight:bold; color:#7f3586;">
          Rp ${(d.saldo || 0).toLocaleString("id-ID")}
        </td>
        <td style="padding:8px; border-bottom:1px solid #ddd;">
          <button class="tambah-saldo" data-id="${d.id}" 
            style="margin-right:6px; padding:5px 10px; background:green; color:#fff; border:none; border-radius:4px; cursor:pointer;">
            + Tambah
          </button>
          <button class="kurangi-saldo" data-id="${d.id}" 
            style="padding:5px 10px; background:red; color:#fff; border:none; border-radius:4px; cursor:pointer;">
            - Kurangi
          </button>
        </td>
      `;
      saldoHostTable.appendChild(tr);
    });

    // ‚úÖ Tambahkan event listener tombol
    document.querySelectorAll(".tambah-saldo").forEach((btn) => {
      btn.addEventListener("click", () => ubahSaldo(btn.dataset.id, "tambah"));
    });
    document.querySelectorAll(".kurangi-saldo").forEach((btn) => {
      btn.addEventListener("click", () => ubahSaldo(btn.dataset.id, "kurangi"));
    });
  });
}

// ==========================
// üîπ Tambah / Kurangi Saldo
// ==========================
async function ubahSaldo(userId, aksi) {
  const jumlah = parseInt(prompt(`Masukkan jumlah saldo yang ingin di${aksi}:`));
  if (isNaN(jumlah) || jumlah <= 0) {
    alert("Jumlah tidak valid!");
    return;
  }

  try {
    const userRef = doc(db, "pendaftaran", userId);
    const userSnap = await getDoc(userRef);

    if (userSnap.exists()) {
      const userData = userSnap.data();
      const saldoSekarang = userData.saldo || 0;
      let saldoBaru = saldoSekarang;

      if (aksi === "tambah") {
        saldoBaru += jumlah;
      } else if (aksi === "kurangi") {
        saldoBaru -= jumlah;
        if (saldoBaru < 0) saldoBaru = 0; // biar tidak minus
      }

      await updateDoc(userRef, {
        saldo: saldoBaru,
        lastUpdated: serverTimestamp(), // ‚úÖ biar selalu naik ke atas
      });

      alert(`Saldo berhasil di${aksi === "tambah" ? "tambahkan" : "kurangi"}!`);
    }
  } catch (err) {
    console.error("Error ubah saldo:", err);
    alert("Gagal mengubah saldo!");
  }
}

// ‚úÖ Panggil saat halaman admin dibuka
loadSaldoHostData();






// Elemen DOM
const selectUser = document.getElementById("admin-selectUser");
const userInfo = document.getElementById("admin-userInfo");
const selectedUserIdEl = document.getElementById("admin-selectedUserId");
const selectedUserNameEl = document.getElementById("admin-selectedUserName");
const selectedUserCoinEl = document.getElementById("admin-selectedUserCoin");
const selectedUserRekEl = document.getElementById("admin-selectedUserRek");

let unsubscribe = null;

// ‚úÖ Ambil daftar user dari Firestore dan isi dropdown
async function loadUsers() {
    try {
        const querySnapshot = await getDocs(collection(db, "pendaftaran"));
        if (querySnapshot.empty) {
            console.warn("Tidak ada user di koleksi pendaftaran!");
            return;
        }

        querySnapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const namaRek = data.namaRek || "(Tanpa Rekening)";

            const option = document.createElement("option");
            option.value = docSnap.id;
            option.textContent = namaRek; // ‚úÖ hanya tampil Nama Rek
            selectUser.appendChild(option);
        });
    } catch (error) {
        console.error("Gagal memuat user:", error);
    }
}

// ‚úÖ Jalankan loadUsers saat halaman dimuat
loadUsers();

// ‚úÖ Event saat pilih user
selectUser.addEventListener("change", () => {
    const userId = selectUser.value;

    if (!userId) {
        userInfo.style.display = "none";
        if (unsubscribe) unsubscribe();
        return;
    }

    if (unsubscribe) unsubscribe();

    const userRef = doc(db, "pendaftaran", userId);

    // ‚úÖ Listener realtime Firestore
    unsubscribe = onSnapshot(userRef, (docSnap) => {
        if (docSnap.exists()) {
            const data = docSnap.data();

            const namaLengkap = data.namaLengkap || data.username || "-";
            const namaRek = data.namaRek || "-";
            const saldoCoin = data.saldoCoin || 0;

            // isi ke elemen
            selectedUserIdEl.textContent = userId;
            selectedUserNameEl.textContent = namaLengkap;
            selectedUserRekEl.textContent = namaRek;
            selectedUserCoinEl.textContent = saldoCoin;

            userInfo.style.display = "block";
        } else {
            console.warn("User tidak ditemukan");
        }
    });
});



// ‚úÖ Fungsi: Tambah saldo coin
window.tambahSaldoCoin = async function () {
    const userId = selectUser.value;
    if (!userId) return;

    const val = parseInt(prompt("Masukkan jumlah coin yang ingin ditambah:"));
    if (isNaN(val) || val <= 0) return;

    try {
        const userRef = doc(db, "pendaftaran", userId);
        const docSnap = await getDoc(userRef);
        if (!docSnap.exists()) return;

        const data = docSnap.data();
        const saldoCoin = data.saldoCoin || 0;
        const newSaldo = saldoCoin + val;

        await updateDoc(userRef, { saldoCoin: newSaldo });
        alert("Saldo coin berhasil ditambah!");
    } catch (error) {
        console.error("Gagal menambah saldo:", error);
    }
};

// ‚úÖ Fungsi: Kurangi saldo coin
window.kurangiSaldoCoin = async function () {
    const userId = selectUser.value;
    if (!userId) return;

    const val = parseInt(prompt("Masukkan jumlah coin yang ingin dikurangi:"));
    if (isNaN(val) || val <= 0) return;

    try {
        const userRef = doc(db, "pendaftaran", userId);
        const docSnap = await getDoc(userRef);
        if (!docSnap.exists()) return;

        const data = docSnap.data();
        const saldoCoin = data.saldoCoin || 0;
        const newSaldo = Math.max(saldoCoin - val, 0);

        await updateDoc(userRef, { saldoCoin: newSaldo });
        alert("Saldo coin berhasil dikurangi!");
    } catch (error) {
        console.error("Gagal mengurangi saldo:", error);
    }
};






















// ‚úÖ Ambil tabel deposit
const depositTable = document.getElementById("deposit-table");

// ‚úÖ Load data deposit (real-time)
function loadDepositData() {
  let depositRef;
  try {
    depositRef = query(collection(db, "deposit"), orderBy("createdAt", "desc"));
  } catch (err) {
    console.warn("OrderBy gagal, fallback tanpa sort");
    depositRef = collection(db, "deposit");
  }

  onSnapshot(depositRef, (snapshot) => {
    depositTable.innerHTML = ""; // Kosongkan tabel sebelum render ulang

    snapshot.forEach(docSnap => {
      const d = docSnap.data();
      const id = docSnap.id;

      // Buat baris
      const tr = document.createElement("tr");

      // Kolom Nama
      const td1 = document.createElement("td");
      td1.textContent = d.namaPengirim || '-';
      tr.appendChild(td1);

      // Kolom Bank
      const td2 = document.createElement("td");
      td2.textContent = d.bank || '-';
      tr.appendChild(td2);

      // Kolom Nominal
      const td3 = document.createElement("td");
      td3.textContent = `Rp ${(d.nominal || 0).toLocaleString()}`;
      tr.appendChild(td3);

      // Kolom Status
      const td4 = document.createElement("td");
      td4.style.color = d.status === 'pending' ? 'orange' : (d.status === 'approved' ? 'green' : 'red');
      td4.textContent = d.status || '-';
      tr.appendChild(td4);

      // Kolom Aksi
      const td5 = document.createElement("td");

      // Tombol Approve
      const approveBtn = document.createElement("button");
      approveBtn.classList.add("approve-btn");
      approveBtn.dataset.id = id;
      approveBtn.dataset.user = d.userId;
      approveBtn.dataset.nominal = d.nominal || 0;
      approveBtn.textContent = "Approve";
      if (d.status !== 'pending') approveBtn.disabled = true;

      // Tombol Tolak
      const rejectBtn = document.createElement("button");
      rejectBtn.classList.add("reject-btn");
      rejectBtn.dataset.id = id;
      rejectBtn.textContent = "Tolak";
      if (d.status !== 'pending') rejectBtn.disabled = true;

      // Tombol Tambah Saldo
      const addSaldoBtn = document.createElement("button");
      addSaldoBtn.classList.add("add-saldo-btn");
      addSaldoBtn.dataset.user = d.userId;
      addSaldoBtn.textContent = "Tambahkan";

      // Tombol Kurangi Saldo
      const kurangiSaldoBtn = document.createElement("button");
      kurangiSaldoBtn.classList.add("kurangi-saldo-btn");
      kurangiSaldoBtn.dataset.user = d.userId;
      kurangiSaldoBtn.textContent = "Kurangi";

      // Masukkan semua tombol ke kolom aksi
      td5.appendChild(approveBtn);
      td5.appendChild(rejectBtn);


      tr.appendChild(td5);

      // Tambahkan baris ke tabel
      depositTable.appendChild(tr);
    });

    // Tambahkan event listener setelah data dimuat
    addDepositActionListeners();
  });
}

// ‚úÖ Event Listener untuk tombol aksi
function addDepositActionListeners() {
  // Approve
  document.querySelectorAll(".approve-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const depositId = btn.dataset.id;
      const userId = btn.dataset.user;
      const nominal = parseInt(btn.dataset.nominal);

      try {
        await updateDoc(doc(db, "deposit", depositId), { status: "approved" });

        const userRef = doc(db, "pendaftaran", userId);
        const userSnap = await getDoc(userRef);

        if (userSnap.exists()) {
          const userData = userSnap.data();
          const saldoRupiah = userData.saldoRupiah || 0;
          const saldoBaru = saldoRupiah + nominal;

          await updateDoc(userRef, { saldoRupiah: saldoBaru });
        }

        alert("‚úÖ Deposit berhasil di-approve dan saldo Rupiah bertambah!");
      } catch (error) {
        console.error("Gagal approve deposit:", error);
        alert("‚ùå Terjadi kesalahan saat approve deposit");
      }
    });
  });

  // Reject
  document.querySelectorAll(".reject-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const depositId = btn.dataset.id;
      await updateDoc(doc(db, "deposit", depositId), { status: "rejected" });
      alert("Deposit ditolak!");
    });
  });

  // Tambahkan Saldo
  document.querySelectorAll(".add-saldo-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const userId = btn.dataset.user;
      const amountToAdd = prompt("Masukkan jumlah saldo yang ingin ditambahkan:");

      if (isNaN(amountToAdd) || amountToAdd <= 0) {
        alert("Jumlah saldo tidak valid!");
        return;
      }

      try {
        const userRef = doc(db, "pendaftaran", userId);
        const userSnap = await getDoc(userRef);

        if (userSnap.exists()) {
          const userData = userSnap.data();
          const saldoRupiah = userData.saldoRupiah || 0;
          const newSaldo = saldoRupiah + parseInt(amountToAdd);

          await updateDoc(userRef, { saldoRupiah: newSaldo });
        }

        alert("Saldo berhasil ditambahkan!");
      } catch (error) {
        console.error("Gagal menambah saldo:", error);
        alert("‚ùå Terjadi kesalahan saat menambah saldo");
      }
    });
  });

  // Kurangi Saldo
  document.querySelectorAll(".kurangi-saldo-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const userId = btn.dataset.user;
      const amountToSubtract = prompt("Masukkan jumlah saldo yang ingin dikurangi:");

      if (isNaN(amountToSubtract) || amountToSubtract <= 0) {
        alert("Jumlah saldo tidak valid!");
        return;
      }

      try {
        const userRef = doc(db, "pendaftaran", userId);
        const userSnap = await getDoc(userRef);

        if (userSnap.exists()) {
          const userData = userSnap.data();
          const saldoRupiah = userData.saldoRupiah || 0;
          const newSaldo = saldoRupiah - parseInt(amountToSubtract);

          await updateDoc(userRef, { saldoRupiah: newSaldo });
        }

        alert("Saldo berhasil dikurangi!");
      } catch (error) {
        console.error("Gagal mengurangi saldo:", error);
        alert("‚ùå Terjadi kesalahan saat mengurangi saldo");
      }
    });
  });
}

// ‚úÖ Panggil ini hanya sekali saat halaman dimuat
loadDepositData();
















document.addEventListener("DOMContentLoaded", () => {
  const dataUserTable = document.getElementById("data-user-table");
  const saldoUserTable = document.getElementById("saldo-user-table");
  const withdrawTable = document.getElementById("withdraw-user-table");
  const notifBox = document.getElementById("notif-box");

  const usersRef = collection(db, "pendaftaran");

  // ========================
  // üîπ Render User Data
  // ========================
  function renderUserRow(userId, data) {
  const tr = document.createElement("tr");
  tr.dataset.userId = userId; // Tambahkan untuk referensi nanti

  tr.innerHTML = `
    <td>${data.nama || '-'}</td>
    <td>${data.umur || '-'}</td>
    <td>${data.jk || '-'}</td>
    <td>${data.wa || '-'}</td>
    <td>${data.email || '-'}</td>
    <td>${data.app || '-'}</td>
    <td>${data.bank || '-'}</td>
    <td>${data.namaRek || '-'}</td>
    <td>${data.noRek || '-'}</td>
    <td>${data.fotoURL ? `<img src="${data.fotoURL}" width="50">` : ''}</td>
    <td>
      ${data.verified 
        ? `<span style="color:green;font-weight:bold;">Diverifikasi</span>` 
        : `<span style="color:red;font-weight:bold;">Unverifikasi</span>`}
    </td>
<td>
  <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:6px;">
    <button class="verify-btn" data-id="${userId}" data-status="true">Verifikasi</button>
    <button class="verify-btn" data-id="${userId}" data-status="false">Batalkan</button>

    <button class="delete-btn" data-id="${userId}" 
      style="color:#fff; background:red;">Delete</button>
    <button class="mark-btn" data-id="${userId}" 
      style="background:orange; color:#fff;">Sudah</button>

    <button class="note-btn" data-id="${userId}" data-nama="${data.nama || '-'}" 
      style="background:#4caf50; color:#fff;">Catatan</button>
    <div id="suuukkses-${userId}" class="suuukkses-btn" 
      style="padding:5px 10px; background:#ddd; border-radius:4px; cursor:pointer; text-align:center;">
      Sukses
    </div>
  </div>
</td>
  
  `;

  
  // ‚úÖ Jika statusHijau = true ‚Üí seluruh baris hijau
  if (data.statusHijau) {
    tr.style.background = "#4caf50";  // hijau
    tr.style.color = "#fff";          // teks putih
  }



  
document.addEventListener("click", async function(e) {
  if (e.target.classList.contains("suuukkses-btn")) {
    const userId = e.target.id.replace("suuukkses-", "");
    const docRef = doc(db, "pendaftaran", userId);
    const docSnap = await getDoc(docRef);

    let statusHijau = false;
    if (docSnap.exists()) {
      statusHijau = docSnap.data().statusHijau || false;
    }

    // ‚úÖ Update Firestore
    await updateDoc(docRef, { statusHijau: !statusHijau });

    // ‚úÖ UI langsung berubah tanpa reload
    const row = document.getElementById(`row-${userId}`);
    if (!statusHijau) {
      row.style.background = "#4caf50"; // hijau
      row.style.color = "#4caf50";         // teks putih
    } else {
      row.style.background = "";  // kembali normal
      row.style.color = "";
    }
  }
});





let currentUserId = null;
let currentUserName = null;

// ‚úÖ Klik tombol "Catatan"
document.addEventListener("click", function (e) {
  if (e.target.classList.contains("note-btn")) {
    currentUserId = e.target.dataset.id;
    currentUserName = e.target.dataset.nama;

    document.getElementById("userNamaModal").innerText = currentUserName;
    openCatatan();
    loadCatatan(currentUserId);
  }
});

function openCatatan() {
  document.getElementById("catatanModal").style.display = "flex";
}

function closeCatatan() {
  document.getElementById("catatanModal").style.display = "none";
}

// ‚úÖ Klik di luar modal untuk menutup
document.getElementById("catatanModal").addEventListener("click", function (e) {
  if (e.target === this) {
    closeCatatan();
  }
});

// ‚úÖ Load catatan per user + tombol hapus pakai ID unik
async function loadCatatan(userId) {
  const catatanList = document.getElementById("catatanList");
  catatanList.innerHTML = ""; // ‚úÖ Reset agar tidak duplikat
  document.getElementById("totalPembayaran").innerText = "Rp 0";

  const q = query(collection(db, "pendaftaran", userId, "catatan"), orderBy("tanggal", "desc"));
  const snapshot = await getDocs(q);

  let total = 0;
  let html = "<ul>";
  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    total += data.nominal;

    const tombolId = `hapus-catatan-${docSnap.id}`;

    html += `
      <li>
        ${data.transaksi} - Rp ${data.nominal.toLocaleString()} (${data.namaPembayaran})
        <button id="${tombolId}" style="margin-left:10px;color:#fff;background:red;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">Hapus</button>
      </li>
    `;
  });
  html += "</ul>";

  catatanList.innerHTML = html;

  document.getElementById("totalPembayaran").innerText = "Rp " + total.toLocaleString();

  // ‚úÖ Tambahkan event listener khusus untuk setiap tombol ID unik
  snapshot.forEach(docSnap => {
    const tombolId = `hapus-catatan-${docSnap.id}`;
    document.getElementById(tombolId).onclick = async function () {
      if (confirm("Yakin ingin menghapus catatan ini?")) {
        await deleteDoc(doc(db, "pendaftaran", currentUserId, "catatan", docSnap.id));
        loadCatatan(currentUserId);
      }
    };
  });
}

// ‚úÖ Tambah catatan (PER USER)
document.getElementById("catatanForm").onsubmit = async function (e) {
  e.preventDefault();

  if (!currentUserId) {
    alert("User tidak ditemukan!");
    return;
  }

  const transaksi = document.getElementById("transaksi").value;
  const nominal = parseFloat(document.getElementById("nominal").value);
  const namaPembayaran = document.getElementById("namaPembayaran").value;

  await addDoc(collection(db, "pendaftaran", currentUserId, "catatan"), {
    transaksi,
    nominal,
    namaPembayaran,
    tanggal: new Date()
  });

  this.reset();
  loadCatatan(currentUserId);
};










  // ‚úÖ Jika user sudah ditandai (marked === true), beri class
  if (data.marked === true) {
    tr.classList.add("marked");
  }

  dataUserTable.appendChild(tr);
}


document.addEventListener("click", async function(e) {
  if (e.target.classList.contains("mark-btn")) {
    const userId = e.target.dataset.id;
    const row = e.target.closest("tr");

    const isMarked = row.classList.contains("marked");
    const newStatus = !isMarked;

    try {
      // ‚úÖ Update Firestore field 'marked'
      await updateDoc(doc(db, "pendaftaran", userId), {
        marked: newStatus
      });

      // ‚úÖ Update tampilan
      if (newStatus) {
        row.classList.add("marked");
      } else {
        row.classList.remove("marked");
      }
    } catch (error) {
      console.error("Gagal update tanda:", error);
    }
  }
});

onSnapshot(usersRef, (snapshot) => {
  dataUserTable.innerHTML = ""; // bersihkan tabel dulu
  snapshot.forEach((docSnap) => {
    renderUserRow(docSnap.id, docSnap.data());
  });
});






// ========================
// üîπ Event Hapus Data
// ========================
document.addEventListener("click", async (e) => {
  if (e.target.classList.contains("delete-btn")) {
    const userId = e.target.dataset.id;

    const konfirmasi = confirm("‚ö†Ô∏è Yakin mau hapus data user ini?");
    if (!konfirmasi) return;

    try {
      await deleteDoc(doc(db, "pendaftaran", userId));

      // hapus baris tabel
      const row = e.target.closest("tr");
      if (row) row.remove();

      alert("üóëÔ∏è Data berhasil dihapus");
    } catch (error) {
      console.error("‚ùå Gagal hapus data:", error);
      alert("‚ùå Gagal menghapus data. Cek koneksi anda.");
    }
  }
});





  

const saldoUserTableBody = document.getElementById("saldoUserTableBody");

// ========================
// üîπ Render Saldo
// ========================
function renderSaldoRow(userId, data) {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td style="padding:8px; border-bottom:1px solid #eee;">${data.nama || '-'}</td>
    <td style="padding:8px; border-bottom:1px solid #eee;">${data.email || '-'}</td>
    <td style="padding:8px; border-bottom:1px solid #eee;">Rp ${(data.saldoRupiah || 0).toLocaleString()}</td>
    <td style="padding:8px; border-bottom:1px solid #eee;">
      <select class="status-select" style="padding:4px; border-radius:4px; border:1px solid #ccc;">
        <option value="aktif" ${data.status=="aktif"?"selected":""}>Aktif</option>
        <option value="ditangguhkan" ${data.status=="ditangguhkan"?"selected":""}>Ditangguhkan</option>
        <option value="proses" ${data.status=="proses"?"selected":""}>Proses</option>
        <option value="ditolak" ${data.status=="ditolak"?"selected":""}>Ditolak</option>
        <option value="dihapus" ${data.status=="dihapus"?"selected":""}>Dihapus</option>
      </select>
    </td>
    <td style="padding:8px; border-bottom:1px solid #eee;">
      <button class="add-saldo" style="background:#4caf50; color:#fff; border:none; padding:6px 10px; border-radius:4px; cursor:pointer;">Tambah</button>
      <button class="kurangi-saldo" style="background:#f44336; color:#fff; border:none; padding:6px 10px; border-radius:4px; cursor:pointer; margin-left:5px;">Kurangi</button>
    </td>
  `;
  saldoUserTableBody.appendChild(tr);

  // ‚úÖ Event tambah saldo
  tr.querySelector(".add-saldo").onclick = async () => {
    const val = parseInt(prompt("Masukkan jumlah tambah saldo:"));
    if (!isNaN(val) && val > 0) {
      await updateDoc(doc(db, "pendaftaran", userId), { saldoRupiah: (data.saldoRupiah || 0) + val });
    }
  };

  // ‚úÖ Event kurangi saldo
  tr.querySelector(".kurangi-saldo").onclick = async () => {
    const val = parseInt(prompt("Masukkan jumlah kurangi saldo:"));
    if (!isNaN(val) && val > 0) {
      await updateDoc(doc(db, "pendaftaran", userId), { saldoRupiah: (data.saldoRupiah || 0) - val });
    }
  };

  // ‚úÖ Event ubah status
  tr.querySelector(".status-select").onchange = async (e) => {
    await updateDoc(doc(db, "pendaftaran", userId), { status: e.target.value });
  };
}

// ========================
// üîπ Load semua user ke tabel
// ========================
async function loadSaldoUsers() {
  saldoUserTableBody.innerHTML = ""; // kosongkan dulu

  const querySnapshot = await getDocs(collection(db, "pendaftaran"));
  querySnapshot.forEach((docSnap) => {
    const data = docSnap.data();
    renderSaldoRow(docSnap.id, {
      nama: data.namaLengkap || data.username || "-",
      email: data.email || "-",
      saldoRupiah: data.saldoRupiah || 0,
      status: data.status || "aktif"
    });
  });
}

// ‚úÖ Panggil saat halaman pertama kali dibuka
loadSaldoUsers();



  // ========================
  // üîπ Render Withdraw
  // ========================
  function renderWithdrawRow(userId, data, item, index) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${data.nama || '-'}</td>
      <td>${data.email || '-'}</td>
      <td>${item.bank || '-'}</td>
      <td>${item.norek || '-'}</td>
      <td>${item.namarek || '-'}</td>
      <td>${item.jumlah || 0}</td>
      <td style="color:${item.color || 'black'}">${item.status}</td>
      <td>
        <button class="proses-btn">Proses</button>
        <button class="approve-btn">Approve</button>
        <button class="tolak-btn">Tolak</button>
        <button class="hapus-btn" style="background:red;color:white;">Hapus</button>
      </td>
    `;
    withdrawTable.appendChild(tr);

    // ‚úÖ Update status riwayat
    const updateStatus = async (newStatus, color) => {
      const userRef = doc(db, "pendaftaran", userId);
      const userSnap = await getDoc(userRef);
      const userData = userSnap.data() || {};
      const arr = Array.isArray(userData.riwayat) ? [...userData.riwayat] : [];
      arr[index] = { ...arr[index], status: newStatus, color };
      await updateDoc(userRef, { riwayat: arr });
    };

    // ‚úÖ Event tombol
    tr.querySelector(".proses-btn").onclick = () => updateStatus("Proses", "orange");
    tr.querySelector(".approve-btn").onclick = () => updateStatus("Approve", "green");

    tr.querySelector(".tolak-btn").onclick = async () => {
      const userRef = doc(db, "pendaftaran", userId);
      const userSnap = await getDoc(userRef);
      const userData = userSnap.data() || {};
      const arr = Array.isArray(userData.riwayat) ? [...userData.riwayat] : [];
      if (!arr[index]) return;
      const newSaldo = (userData.saldo || 0) + (arr[index].jumlah || 0);
      arr[index] = { ...arr[index], status: "Tolak", color: "red" };
      await updateDoc(userRef, { riwayat: arr, saldo: newSaldo });
    };

    tr.querySelector(".hapus-btn").onclick = async () => {
      if (!confirm("Yakin ingin menghapus riwayat withdraw ini?")) return;
      const userRef = doc(db, "pendaftaran", userId);
      const userSnap = await getDoc(userRef);
      const userData = userSnap.data() || {};
      let arr = Array.isArray(userData.riwayat) ? [...userData.riwayat] : [];
      arr.splice(index, 1);
      await updateDoc(userRef, { riwayat: arr });
      tr.remove();
    };
  }

  // ========================
  // üîπ Listener Firestore
  // ========================
  onSnapshot(query(usersRef, orderBy("createdAt", "desc")), (snapshot) => {
    dataUserTable.innerHTML = "";
    saldoUserTable.innerHTML = "";
    withdrawTable.innerHTML = "";

    snapshot.forEach((docSnap) => {
      const data = docSnap.data();
      const userId = docSnap.id;

      // ‚úÖ Pastikan user punya saldo & status
      if (data.saldo === undefined) {
        updateDoc(doc(db, "pendaftaran", userId), { saldo: 0, status: "aktif" });
      }

      // ‚úÖ Render tabel user & saldo
      renderUserRow(userId, data);
      renderSaldoRow(userId, data);

      // ‚úÖ Render withdraw
      const riwayat = Array.isArray(data.riwayat) ? data.riwayat : [];
      riwayat.forEach((item, index) => renderWithdrawRow(userId, data, item, index));

      // ‚úÖ Notif user baru
      const isNew = data.createdAt && (new Date() - data.createdAt.toDate()) < 24 * 60 * 60 * 1000;
      if (isNew) {
        notifBox.innerText = `üö® User baru mendaftar: ${data.nama || 'User Baru'}`;
        notifBox.style.display = "block";
        setTimeout(() => notifBox.style.display = "none", 3000);
      }
    });
  });

  // ========================
  // üîπ Event Verifikasi
  // ========================
  document.addEventListener("click", async (e) => {
    if (e.target.classList.contains("verify-btn")) {
      const userId = e.target.dataset.id;
      const status = e.target.dataset.status === "true";

      const konfirmasi = confirm(`Apakah Anda yakin ingin ${status ? 'memverifikasi' : 'membatalkan verifikasi'} user ini?`);
      if (!konfirmasi) return;

      try {
        await updateDoc(doc(db, "pendaftaran", userId), { verified: status });
        alert(`‚úÖ Status berhasil diubah menjadi ${status ? 'Diverifikasi' : 'Unverifikasi'}`);
      } catch (error) {
        console.error("Gagal ubah status:", error);
        alert("‚ùå Gagal mengubah status. Cek koneksi atau Firestore rules.");
      }
    }
  });
});



// ‚úÖ Load daftar user dari collection pendaftaran
async function loadUserList() {
  const userListEl = document.getElementById('userList');
  userListEl.innerHTML = '<p>Loading...</p>';

  const usersSnap = await getDocs(collection(db, 'pendaftaran'));
  let html = '';

  usersSnap.forEach(docSnap => {
    const data = docSnap.data();
    html += `
      <div style="border:1px solid #ccc; padding:10px; margin-bottom:8px; border-radius:6px; cursor:pointer;" 
        onclick="openSendMessagePopup('${docSnap.id}', '${data.nama || ''}', '${data.email || ''}', '${data.wa || ''}')">
        <strong>${data.nama || '-'}</strong><br>
        Email: ${data.email || '-'}<br>
        WA: ${data.wa || '-'}
      </div>
    `;
  });

  userListEl.innerHTML = html || '<p>Tidak ada user.</p>';
}

// ‚úÖ Buka popup kirim pesan
window.openSendMessagePopup = function(userId, nama, email, wa) {
  document.getElementById('sendMessagePopup').style.display = 'block';
  document.querySelector('#sendMessageForm input[name="userId"]').value = userId;
  document.querySelector('#sendMessagePopup h3').innerText = `Kirim Pesan ke ${nama}`;
  document.getElementById('chatInfo').innerHTML = `
    <p><strong>Nama:</strong> ${nama}</p>
    <p><strong>Email:</strong> ${email}</p>
    <p><strong>WA:</strong> ${wa}</p>
  `;
  loadChatHistory(userId);
};

// ‚úÖ Tutup popup kirim pesan
window.closeSendMessagePopup = function() {
  document.getElementById('sendMessagePopup').style.display = 'none';
};

// ‚úÖ Tutup popup CS
window.closeCsPopup = function() {
  document.getElementById('csPopup').style.display = 'none';
  document.getElementById('csOverlay').style.display = 'none';
};

// ‚úÖ Kirim pesan ke Firestore
document.getElementById('sendMessageForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const userId = this.userId.value;
  const pesan = this.message.value.trim();
  if (!pesan) return;

  await addDoc(collection(db, 'pesan'), {
    userId: userId,
    pesan: pesan,
    sender: 'admin', // ‚úÖ Tandai pengirim
    timestamp: serverTimestamp()
  });

  this.message.value = '';
});

// ‚úÖ Load riwayat chat user (REAL-TIME)
function loadChatHistory(userId) {
  const chatBox = document.getElementById('chatHistory');
  chatBox.innerHTML = '<p>Loading chat...</p>';

  const q = query(
    collection(db, 'pesan'),
    where('userId', '==', userId),
    orderBy('timestamp', 'asc')
  );

  // ‚úÖ Dengarkan perubahan data (real-time)
  onSnapshot(q, (snapshot) => {
    if (snapshot.empty) {
      chatBox.innerHTML = '<p>Belum ada pesan.</p>';
      return;
    }

    chatBox.innerHTML = ''; // Hapus konten lama

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const senderName = data.sender === 'admin' ? '<strong>Admin:</strong>' : '<strong>User:</strong>';

      // ‚úÖ Buat wrapper pesan
      const wrapper = document.createElement('div');
      wrapper.classList.add('chat-item');
      wrapper.setAttribute('data-id', docSnap.id);
      wrapper.style.display = 'flex';
      wrapper.style.alignItems = 'center';
      wrapper.style.marginBottom = '8px';

      // ‚úÖ Teks pesan
      const messageText = document.createElement('p');
      messageText.style.flex = '1';
      messageText.style.margin = '0';
      messageText.innerHTML = `${senderName} ${data.pesan}`;

      // ‚úÖ Ikon hapus
      const deleteIcon = document.createElement('img');
      deleteIcon.src = 'servant_icon.png';
      deleteIcon.alt = 'Hapus';
      deleteIcon.title = 'Hapus Pesan';
      deleteIcon.classList.add('delete-icon'); // CSS hover effect
      deleteIcon.style.width = '18px';
      deleteIcon.style.height = '18px';
      deleteIcon.style.cursor = 'pointer';
      deleteIcon.style.marginLeft = '8px';

      // ‚úÖ Tambahkan event hapus
      deleteIcon.addEventListener('click', () => deleteMessage(docSnap.id, wrapper));

      // ‚úÖ Gabungkan ke wrapper
      wrapper.appendChild(messageText);
      wrapper.appendChild(deleteIcon);

      chatBox.appendChild(wrapper);
    });

    // ‚úÖ Auto scroll ke bawah
    chatBox.scrollTop = chatBox.scrollHeight;
  });
}

// ‚úÖ Fungsi hapus pesan (SweetAlert konfirmasi)
async function deleteMessage(messageId, element) {
  const result = await Swal.fire({
    title: 'Yakin hapus pesan ini?',
    text: "Pesan akan dihapus permanen",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Ya, hapus!',
    cancelButtonText: 'Batal'
  });

  if (result.isConfirmed) {
    try {
      await deleteDoc(doc(db, 'pesan', messageId));
      element.style.transition = 'opacity 0.3s';
      element.style.opacity = '0';
      setTimeout(() => element.remove(), 300);
      Swal.fire('Berhasil!', 'Pesan sudah dihapus.', 'success');
    } catch (error) {
      console.error('Gagal menghapus pesan:', error);
      Swal.fire('Gagal!', 'Terjadi kesalahan saat menghapus.', 'error');
    }
  }
}

// ‚úÖ Buka popup CS (list user)
window.openCsPopup = function() {
  document.getElementById("csPopup").style.display = "block";
  document.getElementById("csOverlay").style.display = "block";
  loadUserList(); 
};







async function loadAnalisisForm() {
  const docRef = doc(db, "analisis", "data");
  const docSnap = await getDoc(docRef);

  if (docSnap.exists()) {
    const data = docSnap.data();
    document.getElementById('setPemasukan').value = data.pemasukan;
    document.getElementById('setPengeluaran').value = data.pengeluaran;
    document.getElementById('setUserBagus').value = data.userBagus;
    document.getElementById('setUserBuruk').value = data.userBuruk;
    document.getElementById('setPuas').value = data.totalPuas;
    document.getElementById('setTidakPuas').value = data.totalTidakPuas;
  }
}


function showPage(page) {
  document.querySelectorAll('[id^="ubah"], [id^="data"], [id^="saldo"], [id^="withdraw"], [id^="deposit"], [id^="updateTagihan"]').forEach(div => div.style.display = 'none');
  document.getElementById(page).style.display = 'block';

  if (page === 'ubahAnalisis') {
    loadAnalisisForm();
  }
}



document.getElementById('saveAnalisis').addEventListener('click', async () => {
  const data = {
    pemasukan: Number(document.getElementById('setPemasukan').value),
    pengeluaran: Number(document.getElementById('setPengeluaran').value),
    userBagus: Number(document.getElementById('setUserBagus').value),
    userBuruk: Number(document.getElementById('setUserBuruk').value),
    totalPuas: Number(document.getElementById('setPuas').value),
    totalTidakPuas: Number(document.getElementById('setTidakPuas').value)
  };

  try {
    await setDoc(doc(db, "analisis", "data"), data);
    Swal.fire('‚úÖ Berhasil!', 'Data analisis berhasil disimpan di Firebase.', 'success');
  } catch (error) {
    console.error("Gagal menyimpan data:", error);
    Swal.fire('‚ùå Gagal!', 'Terjadi kesalahan saat menyimpan data.', 'error');
  }
});



</script>

<style>
body {
  margin:0;
  font-family:Arial,sans-serif;
  background:#f5f6fa;
}

/* --- Sidebar --- */
.sidebar {
  width:220px;
  height:100vh;
  position:fixed;
  background:#2f3640;
  color:#fff;
  padding-top:20px;
  transition: transform 0.3s ease;
}
.sidebar h2 {text-align:center;margin-bottom:30px;}
.sidebar ul {list-style:none;padding:0;margin:0;}
.sidebar ul li {padding:15px 20px;cursor:pointer;transition:0.2s;}
.sidebar ul li:hover {background:#718093;}




 .delete-icon:hover {
    filter: brightness(0.8);
    transform: scale(1.1);
    transition: 0.2s;
  }
  #csPopup, #sendMessagePopup {
    display: none;
    position: fixed;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    background: #fff;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 999;
    width: 90%;
    max-width: 500px;
  }
  #csOverlay {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 998;
  }
  .chat-item {
    border-bottom: 1px solid #ddd;
    padding: 5px 0;
  }

.swal2-container {
  z-index: 2147483647 !important; /* Maksimum */
}


/* --- Main Content --- */
.main {
  margin-left:0px;
  padding:10px 20px 20px; /* top padding biar tidak ketimpa navbar */
  transition: margin-left 0.3s ease;
}

h1{margin-top:0; font-size: 15px;}
table {
  width:100%;
  border-collapse: collapse;
  background:#fff;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
}
table th, table td {
  padding:10px;
  border:1px solid #ddd;
  text-align:left;
  font-size:13px;
}

table th {
  background-image: url('no_match_times_open_vip_bg.png');
  background-size: cover;      /* biar nutup penuh */
  background-position: center; /* fokus tengah */
  color: #ffffff;
}




#csOverlay {
    display:none;
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.5); z-index:999;
    pointer-events:none; /* Tambahkan ini supaya overlay tidak blok klik */
}


#dropdownMenu {
  display: none;
}
#dropdownMenu.show {
  display: block;
}







#notif-box {
  display:none;
  position: fixed;
  top:100px;
  right:10px;
  background: #08751a;
  color:#fff;
  padding:10px 20px;
  border-radius:5px;
  z-index:1000;
  font-size: 20px;
}
.page {display:none;}
.page.active {display:block;}
button {padding:4px 8px;  border-radius: 10px;   background: #4356d4;
    color: #ffff;  margin-right:4px;cursor:pointer;}
.status-select {padding:4px;}

/* --- Top Navbar --- */
.topnav {
  top: 0;
  left: 220px; /* biar tidak nutup sidebar */
  right: 0;
  height: 50px;
  background: #2f3640;
  display: flex;
  align-items: center;
  padding: 0 0px;
  color: white;
  z-index: 1001;
}

.topnav .menu-btn {
  background: none;
  border: none;
  font-size: 20px;
  color: white;
  cursor: pointer;
}

.logo {
  display: flex;
  align-items: center;
  gap: 8px; /* jarak antara logo dan teks */
  font-weight: bold;
  font-size: 16px;
  color: white;
}

.logo img {
  height: 30px;
  width: 30px;
  object-fit: contain;
  border-radius: 15px;
}



/* --- Dropdown --- */
.dropdown-content {
  display: none;
  position: absolute;
  right: 0;
  background: #7f3586;
  border-radius: 8px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  padding: 10px;
  z-index: 999;
  min-width: 180px;
  transition: all 0.3s ease-in-out;
}

.dropdown-content a {
  display: block;
  width: 100%;
  font-size: 14px;
  padding: 10px;
  color: #ffffff;
  text-decoration: none;
  box-sizing: border-box;
  border-radius: 4px;
}

.dropdown-content a:hover {
  background: #ffd901;
  color: #000;
}

.dropdown-content.show {
  display: block;
}

.dropdown-content button {
  width: 100%;
  padding: 10px;
  border: none;
  border-radius: 4px;
  font-size: 14px;
  cursor: pointer;
}

/* --- Responsive Navbar --- */
@media (max-width: 768px) {
  .dropdown-content {
    right: 10px;
    min-width: 160px; /* agar muat di HP */
    padding: 8px;
  }
  .dropdown-content a {
    font-size: 13px;
    padding: 8px;
  }
  .dropdown-content button {
    font-size: 13px;
    padding: 8px;
  }
}

/* --- Sidebar Responsive --- */
@media (max-width: 768px) {
  .sidebar {
    transform: translateX(-100%);
    transition: transform 0.3s ease-in-out;
  }
  .sidebar.active {
    transform: translateX(0);
  }
  .main {
    margin-left: 0;
  }
}


.approve-btn {
  background-color: #28a745; /* hijau */
  color: #fff;
  border: none;
  padding: 6px 12px;
  border-radius: 5px;
  cursor: pointer;
  transition: background 0.2s;
}

.approve-btn:hover {
  background-color: #218838; /* hijau lebih gelap saat hover */
}


.proses-btn {
  background-color: #ffc107; /* kuning */
  color: #000;  /* teks hitam agar kontras */
  border: none;
  padding: 6px 12px;
  border-radius: 5px;
  cursor: pointer;
  transition: background 0.2s;
}

.proses-btn:hover {
  background-color: #e0a800; /* kuning lebih gelap saat hover */
}


.tolak-btn {
  background-color: #c82333; /* merah tua */
  color: #fff; /* teks putih biar kontras */
  border: none;
  padding: 6px 12px;
  border-radius: 5px;
  cursor: pointer;
  transition: background 0.2s;
}

.tolak-btn:hover {
  background-color: #a71d2a; /* merah lebih gelap saat hover */
}


.add-saldo {
  background-color: #28a745; /* hijau */
  color: #fff; /* teks putih */
  border: none;
  padding: 6px 12px;
  border-radius: 5px;
  cursor: pointer;
  transition: background 0.2s;
}

.add-saldo:hover {
  background-color: #218838; /* hijau lebih gelap saat hover */
}

.kurangi-saldo {
  background-color: #dc3545; /* merah */
  color: #fff; /* teks putih */
  border: none;
  padding: 6px 12px;
  border-radius: 5px;
  cursor: pointer;
  transition: background 0.2s;
}

.kurangi-saldo:hover {
  background-color: #c82333; /* merah lebih gelap saat hover */
}



.marked {
  background-color: #fff3cd !important; /* kuning soft */
}

#catatanModal {
  display: none; 
  position: fixed; 
  top: 0; 
  left: 0; 
  width: 100%; 
  height: 100%; 
  background: rgba(0, 0, 0, 0.6); 
  justify-content: center; 
  align-items: center;
  z-index: 9999;
}
#catatanModal.show {
  display: flex;
}






#ststussssloginnnn, #stattauslogoutt {
  background: #f8f8f8;
  border-radius: 10px;
  padding: 15px;

  left: -0px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes fadeOut {
  from { opacity: 1; transform: translateY(0); }
  to { opacity: 0; transform: translateY(-10px); }
}






/* Menu Navigasi */
.menu-merah {
  color: rgb(255, 0, 0);
  font-weight: bold;   /* opsional, biar lebih tegas */
  text-decoration: none; /* hilangkan underline */
  background: #9d30b6;
}
.menu-merah:hover {
  color: darkred; /* pas hover jadi merah gelap */
}










</style>
</head>
<body>



<!-- ‚úÖ Form Login -->
<div id="loginPage" style="
  display:flex;
  justify-content:center;
  align-items:center;
  height:95vh;
  flex-direction:column;
  background-image:url('no_match_times_charge_bg.png');
  background-size:cover;
  background-position:center;
  background-repeat:no-repeat;
">
  <div style="
    position:relative;
    z-index:2;
    background:#974ff5;
    padding:30px;
    border-radius:12px;
    box-shadow:0 4px 15px rgba(0,0,0,0.3);
    min-width:250px;
    max-width:350px;
    width:90%;
    text-align:center;
  ">
    <img src="servant_icon.png" alt="Offline" style="width:50px;height:50px;margin-bottom:15px;">
    <h2 style="margin-bottom:20px;color:#fff;">Login Admin</h2>
    <input type="text" id="adminEmail" placeholder="Cingkong" style="margin-bottom:10px;padding:8px;border-radius:10px;width:100%;box-sizing:border-box;">
    <input type="password" id="adminPin" placeholder="Password" style="margin-bottom:10px;padding:8px;border-radius:10px;width:100%;box-sizing:border-box;">
    <button id="loginBtn" style="padding:10px 20px;background:#b709d0;color:#fff;border:none;border-radius:6px;cursor:pointer;width:100%;">Login</button>
  </div>
</div>

<!-- ‚úÖ Dashboard -->
<div id="dashboard" style="display:none;">
  <tbody id="dataUserTable"></tbody>

  <!-- ‚úÖ Status Login -->
  <div id="ststussssloginnnn" style="display:none;margin:15px auto;text-align:center;">
    <img id="statusImageLogin" src="offline.png" alt="Status" style="width:40px;height:40px;">
    <div id="statusTextLogin" style="font-size:18px;font-weight:bold;color:#444;margin-top:8px;">Offline</div>
    <div id="statusMessageLogin" style="font-size:14px;color:#666;"></div>
  </div>

  <!-- ‚úÖ Status Logout -->
  <div id="stattauslogoutt" style="display:none;text-align:center;margin:15px auto;">
    <img id="statusImageLogout" src="offline.png" alt="Status" style="width:40px;height:40px;">
    <div id="statusTextLogout" style="font-size:18px;font-weight:bold;color:#444;margin-top:8px;">Offline</div>
    <div id="statusMessageLogout" style="font-size:14px;color:#666;"></div>
  </div>

  <!-- ‚úÖ Navbar -->
  <div style="
    display:flex;
    justify-content:space-between;
    align-items:center;
    flex-wrap:wrap;
    padding:10px 15px;
    background-image:url('no_match_times_charge_bg.png');
    background-size:cover;
    background-position:center;
    color:#fff;
    width:100%;
    box-sizing:border-box;
  ">
    <div style="display:flex;align-items:center;gap:10px;">
      <img src="agencylogo.png" alt="Logo" style="width:25px;height:25px;border-radius:50%;">
      <span style="font-weight:bold;font-size:20px;">ADMIN CS</span>
      <img src="servant_icon.png" alt="CS" onclick="openCsPopup()" style="width:30px;height:30px;cursor:pointer;" onerror="this.src='https://via.placeholder.com/30'">
    </div>
    <div style="position:relative;">
      <button onclick="toggleDropdown()" style="background:#fff;color:#7f3586;border:none;padding:5px 10px;border-radius:6px;cursor:pointer;">‚öô Menu</button>
      <div id="dropdownMenu" class="dropdown-content" style="display:none;position:absolute;background:#7f3586;box-shadow:0 4px 8px rgb(255,255,255);border-radius:6px;padding:50px;z-index:999;">
        <a href="#" onclick="showPage('data'); toggleDropdown();">Semua Data</a>
        <a href="#" onclick="showPage('saldoHostAdmin'); toggleDropdown();">Saldo Host</a>
        <a href="#" onclick="showPage('userdpo'); toggleDropdown();">Request Withdraw</a>
        <a href="#" onclick="showPage('updateTagihan'); toggleDropdown();">Tagihan</a>
        <a href="#" onclick="showPage('tambahCreditSection'); toggleDropdown(); openTambahCredit();">Tambah Credit</a>
        <a href="#" onclick="showPage('kelolaCoin'); toggleDropdown();">Kelola Coin</a>
<a href="#" onclick="showPage('chatControl'); loadChatControl(); toggleDropdown();"> Kontrol Chat</a>



<a href="https://databaseee1.github.io/TigoApp/analisist%20data%20host/"class="menu-merah" onclick="toggleDropdown();">Analisis Data</a>
<a href="https://databaseee1.github.io/TigoApp/invoicedeposit/index.html"class="menu-merah" onclick="toggleDropdown();">Invoice</a>
<a href="#"class="menu-merah"onclick="showPage('ubahAnalisis'); toggleDropdown();">Ubah Analisis</a>
<a href="#" class="menu-merah" onclick="showPage('kelolaSaldo'); toggleDropdown();">Status akun</a>
<a href="#" class="menu-merah" onclick="showPage('withdraw'); toggleDropdown();">Request lama</a>
<a href="#" class="menu-merah" onclick="showPage('deposit'); toggleDropdown();">Request Deposit</a>

        <div>
          <button id="logoutBtn" style="background:red;color:#fff;padding:6px 12px;border:none;border-radius:4px;margin-top:10px;">Logout</button>
        </div>
      </div>
    </div>
  </div>




<!-- ‚úÖ Halaman Kontrol Chat -->
<div id="chatControl" class="page" style="display:none; padding:20px;">
  <h2>Kontrol Chat User</h2>
  <table border="1" cellpadding="8" cellspacing="0" style="width:100%; margin-top:10px;">
    <thead>
      <tr>
        <th>Nama</th>
        <th>Email</th>
        <th>WA</th>
        <th>Status Chat</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody id="chatControlTable">
      <!-- isi akan diload lewat JS -->
    </tbody>
  </table>
</div>















  <!-- ‚úÖ Tambah Credit Section -->
  <div id="tambahCreditSection"  class="page" style="display:none;padding:20px;">
    <h2>Manajemen Credit User</h2>
    <table border="1" cellpadding="8" cellspacing="0" style="width:100%;margin-top:10px;">
      <thead>
        <tr>
          <th>Nama</th>
          <th>Email</th>
          <th>WA</th>
          <th>Saldo Credit</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="userCreditTable"></tbody>
    </table>
  </div>





<!-- ‚úÖ User DPO -->
<div id="userdpo" class="page" style="display:none; padding:20px;">
  <h2>Permintaan Deposit User</h2>
  <table border="1" width="100%" style="border-collapse:collapse;text-align:center;">
    <thead style="background:#eee;">
      <tr>
        <th>Nama Lengkap</th>
        <th>Email</th>
        <th>No WA</th>
        <th>Total Deposit</th>
        <th>Terakhir Deposit</th>
        <th>Status Deposit</th>
        <th>Status Akun</th> <!-- üîπ kolom tambahan -->
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody id="userdpoTableBody"></tbody>
  </table>
  <div id="grandTotal" style="margin-top:15px;font-weight:bold;"></div>
</div>
















  <!-- ‚úÖ Overlay -->
  <div id="csOverlay" onclick="closeAllPopups()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;"></div>

  <!-- ‚úÖ Popup CS -->
  <div id="csPopup" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:10px;padding:20px;box-shadow:0 6px 12px rgba(0,0,0,0.2);z-index:10000;width:90%;max-width:500px;">
    <h3 style="text-align:center;color:#7f3586;margin-top:0;">Daftar User</h3>
    <div id="userList" style="max-height:300px;overflow-y:auto;margin-top:15px;border:1px solid #ddd;border-radius:6px;padding:5px;"></div>
    <button onclick="closeCsPopup()" style="background:#ccc;border:none;padding:10px;width:100%;margin-top:10px;border-radius:6px;cursor:pointer;">Tutup</button>
  </div>

  <!-- ‚úÖ Popup Kirim Pesan -->
  <div id="sendMessagePopup" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;width:90%;max-width:400px;border-radius:10px;padding:20px;box-shadow:0 6px 12px rgba(0,0,0,0.2);z-index:10001;">
    <h3 style="text-align:center;color:#7f3586;">Kirim Pesan</h3>
    <div id="chatInfo" style="margin-bottom:10px;font-size:14px;color:#333;"></div>
    <div id="chatHistory" style="max-height:150px;overflow-y:auto;border:1px solid #ccc;padding:8px;margin-bottom:10px;border-radius:6px;"></div>
    <form id="sendMessageForm">
      <input type="hidden" name="userId">
      <textarea name="message" placeholder="Tulis pesan..." required style="width:100%;padding:10px;margin-top:10px;border-radius:6px;border:1px solid #ccc;height:100px;"></textarea>
      <button type="submit" style="background:#7f3586;color:#fff;padding:12px;border:none;border-radius:8px;width:100%;margin-top:10px;">Kirim</button>
    </form>
    <button onclick="closeSendMessagePopup()" style="background:#ccc;border:none;padding:10px;width:100%;margin-top:10px;border-radius:6px;">Batal</button>
  </div>

  <!-- ‚úÖ Deposit -->
  <div id="deposit" class="page" style="display:none;">
    <h1>Deposit User</h1>
    <table border="1" cellspacing="0" cellpadding="8" style="width:100%;border-collapse:collapse;">
      <thead>
        <tr>
          <th>Nama Pengirim</th>
          <th>Bank</th>
          <th>Nominal</th>
          <th>Status</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="deposit-table"></tbody>
    </table>
  </div>

  <!-- ‚úÖ Saldo Host -->
<!-- ‚úÖ Saldo Host -->
<div id="saldoHostAdmin" class="page" style="display:none; padding:20px;">
  <h2>Kelola Saldo Host</h2>
  <table id="saldoHostTable" border="1" style="width:100%; border-collapse:collapse; margin-top:10px;">
    <thead style="background:#7f3586;color:#fff;">
      <tr>
        <th style="padding:8px;">Nama</th>
        <th style="padding:8px;">Email</th>
        <th style="padding:8px;">WA</th>
        <th style="padding:8px;">Saldo Host</th>
        <th style="padding:8px;">Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>









  <!-- ‚úÖ Main Content -->
  <div class="main">
    <div id="notif-box"></div>

    <div id="saldo" class="page">
      <h1>Saldo User</h1>
      <table>
        <thead>
          <tr>
            <th>Nama</th>
            <th>Email</th>
            <th>Saldo</th>
            <th>Status</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="saldo-user-table"></tbody>
      </table>
    </div>

    <div id="data" class="page active">
      <h1>Data User</h1>
      <input type="text" id="searchInput" placeholder="Cari data..." style="margin-bottom:10px;border-radius:10px;padding:8px;width:300px;font-size:16px;">
      <table>
        <thead>
          <tr>
            <th>Nama</th>
            <th>Umur</th>
            <th>JK</th>
            <th>WA</th>
            <th>Email</th>
            <th>Aplikasi</th>
            <th>Bank</th>
            <th>Nama Rek</th>
            <th>No Rek</th>
            <th>Foto</th>
            <th>Status Verifikasi</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="data-user-table"></tbody>
      </table>
    </div>

    <div id="withdraw" class="page">
      <h1>User Withdraw</h1>
      <table>
        <thead>
          <tr>
            <th>Nama</th>
            <th>Email</th>
            <th>Bank</th>
            <th>No Rek</th>
            <th>Nama Rek</th>
            <th>Jumlah</th>
            <th>Status</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="withdraw-user-table"></tbody>
      </table>
    </div>
  </div>




<!-- ‚úÖ Catatan Modal -->
<div id="catatanModal" style="
  display:none; position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.6); justify-content:center; align-items:center;
  z-index:9999;">
  <div style="background:#fff; padding:20px; border-radius:10px; width:400px; max-height:90vh; overflow:auto;">
    <h3>Catatan Keuangan: <span id="userNamaModal"></span></h3>
    <form id="catatanForm">
      <label>Transaksi apa:</label>
      <input type="text" id="transaksi" required style="width:100%;"><br><br>

      <label>Nominal:</label>
      <input type="number" id="nominal" required style="width:100%;"><br><br>

      <label>Nama Pembayaran:</label>
      <input type="text" id="namaPembayaran" required style="width:100%;"><br><br>

      <button type="submit" style="background:#4caf50;color:#fff;padding:8px 12px;border:none;border-radius:5px;">
        Tambah Catatan
      </button>
    </form>

    <hr>
    <h4>Riwayat Catatan:</h4>
    <div id="catatanList"></div>
    <h4>Total Pembayaran: <span id="totalPembayaran">Rp 0</span></h4>
  </div>
</div>

<!-- ‚úÖ Ubah Analisis -->
<div id="ubahAnalisis" style="
  display:none; padding:20px; max-width:500px; margin:20px auto;
  background:#fff; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1);
  font-family:Arial,sans-serif;">
  <h2 style="margin-bottom:20px; text-align:center; font-size:20px; color:#333;">
    Ubah Analisis Data
  </h2>

  <div style="margin-bottom:15px;">
    <label>Pemasukan:</label>
    <input type="number" id="setPemasukan" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:8px;">
  </div>
  <div style="margin-bottom:15px;">
    <label>Pengeluaran:</label>
    <input type="number" id="setPengeluaran" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:8px;">
  </div>
  <div style="margin-bottom:15px;">
    <label>User Bagus:</label>
    <input type="number" id="setUserBagus" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:8px;">
  </div>
  <div style="margin-bottom:15px;">
    <label>User Buruk:</label>
    <input type="number" id="setUserBuruk" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:8px;">
  </div>
  <div style="margin-bottom:15px;">
    <label>Total Puas:</label>
    <input type="number" id="setPuas" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:8px;">
  </div>
  <div style="margin-bottom:20px;">
    <label>Total Tidak Puas:</label>
    <input type="number" id="setTidakPuas" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:8px;">
  </div>

  <button id="saveAnalisis" style="
    width:100%; padding:12px; background:#7f3586; color:#fff; border:none;
    border-radius:8px; font-size:16px; font-weight:bold; cursor:pointer;">
    Simpan
  </button>
</div>







<!-- ‚úÖ Halaman Kelola Coin -->
<div id="kelolaCoin" class="page" style="display:none; margin-top:20px; display:flex; justify-content:center;">

  <div style="background:#fff; border-radius:16px; padding:24px; box-shadow:0 6px 18px rgba(0,0,0,0.08); width:100%; max-width:480px; font-family:'Segoe UI', Tahoma, sans-serif;">

    <h2 style="margin:0 0 20px; font-size:22px; font-weight:700; color:#333; text-align:center;">
      üí∞ Kelola Coin User
    </h2>

    <!-- üîπ Dropdown pilih user -->
    <label for="admin-selectUser" style="font-size:14px; font-weight:600; color:#555;">Pilih User:</label>
    <select id="admin-selectUser" onchange="showUserInfo()" 
      style="width:100%; padding:12px; margin-top:8px; border-radius:10px; border:1px solid #ccc; font-size:14px; background:#fafafa; transition:all .2s;">
      <option value="">-- Pilih User --</option>
      <!-- opsi user diisi lewat JS -->
    </select>

    <!-- üîπ Info user -->
    <div id="admin-userInfo" style="display:none; margin-top:24px;">

      <!-- Card info -->
      <div style="background:#f9f9f9; border:1px solid #eee; border-radius:12px; padding:16px;">

        <div style="margin:10px 0; display:flex; justify-content:space-between; font-size:15px; color:#333;">
          <span><b>Nama Rek:</b></span> <span id="admin-selectedUserRek">-</span>
        </div>

        <div style="margin:10px 0; display:flex; justify-content:space-between; font-size:15px; color:#333;">
          <span><b>ID User:</b></span> <span id="admin-selectedUserId">-</span>
        </div>

        <div style="margin:10px 0; display:flex; justify-content:space-between; font-size:15px; color:#333;">
          <span><b>Nama:</b></span> <span id="admin-selectedUserName">-</span>
        </div>

        <div style="margin:10px 0; display:flex; justify-content:space-between; font-size:15px; color:#333;">
          <span><b>Saldo Coin:</b></span> 
          <span id="admin-selectedUserCoin" style="font-weight:700; color:#4caf50;">0</span>
        </div>
      </div>

      <!-- üîπ Tombol aksi -->
      <div style="margin-top:20px; display:flex; gap:12px;">
        <button onclick="tambahSaldoCoin()" 
          style="flex:1; padding:12px; border:none; border-radius:10px; cursor:pointer; font-weight:600; font-size:14px; background:#4caf50; color:white; transition:0.2s; box-shadow:0 3px 6px rgba(0,0,0,0.15);">
          ‚ûï Tambah
        </button>

        <button onclick="kurangiSaldoCoin()" 
          style="flex:1; padding:12px; border:none; border-radius:10px; cursor:pointer; font-weight:600; font-size:14px; background:#f44336; color:white; transition:0.2s; box-shadow:0 3px 6px rgba(0,0,0,0.15);">
          ‚ûñ Kurangi
        </button>
      </div>
    </div>
  </div>
</div>


<!-- Halaman Kelola Saldo User -->
<div id="kelolaSaldo" class="page" style="display:none; margin-top:20px;">

  <div style="background:#fff; border-radius:12px; padding:20px; box-shadow:0 4px 10px rgba(0,0,0,0.1); font-family:Arial,sans-serif;">
    <h2 style="margin-bottom:15px; font-size:20px; border-bottom:1px solid #eee; padding-bottom:8px; color:#333;">
      Kelola Saldo User
    </h2>

    <table style="width:100%; border-collapse:collapse; font-size:14px; text-align:left;" id="saldoUserTable">
      <thead>
        <tr style="background:#f5f5f5;">
          <th style="padding:10px; border-bottom:1px solid #ddd;">Nama</th>
          <th style="padding:10px; border-bottom:1px solid #ddd;">Email</th>
          <th style="padding:10px; border-bottom:1px solid #ddd;">Saldo (Rp)</th>
          <th style="padding:10px; border-bottom:1px solid #ddd;">Status</th>
          <th style="padding:10px; border-bottom:1px solid #ddd;">Aksi</th>
        </tr>
      </thead>
      <tbody id="saldoUserTableBody">
        <!-- ‚úÖ Data user akan diisi otomatis lewat JS renderSaldoRow() -->
      </tbody>
    </table>
  </div>
</div>








<!-- ‚úÖ Update Tagihan -->
<div id="updateTagihan" class="page" style="display:none; padding:20px;">
  <h2>Atur Tagihan</h2>
  <table border="1" cellpadding="8" cellspacing="0" style="width:100%; text-align:left; border-collapse:collapse;">
    <thead style="background:#f5f5f5;">
      <tr>
        <th>Nama</th>
        <th>Email</th>
        <th>WA</th>
        <th>Jumlah Tagihan</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody id="userTable"></tbody>
  </table>
</div>



<!-- ‚úÖ Section Daftar User -->
<div id="userListSection" style="display:none; padding:20px;">
  <h2>Daftar Semua User</h2>
  <table border="1" cellpadding="8" cellspacing="0" style="width:100%; margin-top:10px;">
    <thead>
      <tr>
        <th>Nama</th>
        <th>Email</th>
        <th>WA</th>
        <th>Saldo</th>
        <th>Tagihan</th>
        <th>Status Akun</th>
      </tr>
    </thead>
    <tbody id="userListTable"></tbody>
  </table>
</div>




<!-- ‚úÖ Halaman Kontrol Chat -->
<div id="chatControl" style="display:none; padding:20px;">
  <h2>Kontrol Chat User</h2>
  <table border="1" cellpadding="8" cellspacing="0" style="width:100%; margin-top:10px;">
    <thead>
      <tr>
        <th>Nama</th>
        <th>Email</th>
        <th>WA</th>
        <th>Status Chat</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody id="chatControlTable">
      <!-- isi akan diload lewat JS -->
    </tbody>
  </table>
</div>





</div>  <!-- ‚úÖmenu  tutup login  -->

  </div> <!-- end main -->
<!-- ‚úÖ Tutup Wrapper Dashboard -->
</div> <!-- End of Dashboard -->





<script>











function toggleDropdown() {
  const menu = document.getElementById('dropdownMenu');
  menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
}

// ‚úÖ Klik di luar menu untuk menutup dropdown
document.addEventListener('click', function(event) {
  const menu = document.getElementById('dropdownMenu');
  const button = event.target.closest('button');
  const insideMenu = event.target.closest('.dropdown-content');

  if (!insideMenu && !button) {
    menu.style.display = 'none';
  }
});

function showPage(pageId) {
  // Sembunyikan semua page
  document.querySelectorAll(".page").forEach(p => {
    p.style.display = "none";
    p.classList.remove("active");
  });

  // Tampilkan page yang dipilih
  const activePage = document.getElementById(pageId);
  if (activePage) {
    activePage.style.display = "block";
    activePage.classList.add("active");
  } else {
    console.error(`Halaman dengan ID "${pageId}" tidak ditemukan`);
  }

  // Auto close sidebar di mobile
  if (window.innerWidth <= 768) {
    const sidebar = document.querySelector(".sidebar");
    if (sidebar) sidebar.classList.remove("active");
  }
}



// Hapus akun (soft delete)
window.hapusUser = async function(userId) {
  const userRef = doc(db, "pendaftaran", userId);
  await updateDoc(userRef, { status: "dihapus" });
  alert("‚úÖ Akun berhasil dihapus (soft delete).");
};

// Pulihkan akun
window.pulihkanUser = async function(userId) {
  const userRef = doc(db, "pendaftaran", userId);
  await updateDoc(userRef, { status: "aktif" });
  alert("‚úÖ Akun berhasil dipulihkan.");
};


document.addEventListener("click", function (e) {
  const dropdown = document.getElementById("dropdownMenu");
  const button = e.target.closest("button");

  if (!dropdown.contains(e.target) && !button) {
    dropdown.classList.remove("show");
  }
});



document.getElementById('searchInput').addEventListener('keyup', function() {
  const filter = this.value.toLowerCase();
  const rows = document.querySelectorAll('#data-user-table tr');

  rows.forEach(row => {
    const text = row.innerText.toLowerCase();
    if (text.includes(filter)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
});












// ‚úÖ Email & PIN Admin
const ADMIN_EMAIL = "admin@gmail.com";
const ADMIN_PIN = "1111";

// ‚úÖ Elemen Login & Dashboard
const loginPage = document.getElementById("loginPage");
const dashboard = document.getElementById("dashboard");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");

// ‚úÖ Elemen Status Login
const statusBoxLogin = document.getElementById("ststussssloginnnn");
const statusImageLogin = document.getElementById("statusImageLogin");
const statusTextLogin = document.getElementById("statusTextLogin");
const statusMessageLogin = document.getElementById("statusMessageLogin");

// ‚úÖ Elemen Status Logout
const statusBoxLogout = document.getElementById("stattauslogoutt");
const statusImageLogout = document.getElementById("statusImageLogout");
const statusTextLogout = document.getElementById("statusTextLogout");
const statusMessageLogout = document.getElementById("statusMessageLogout");

// ‚úÖ Tampilkan status login
function setLoginStatus(type, message = "") {
  statusBoxLogin.style.display = "block";

  if (type === "online") {
    statusImageLogin.src = "notifikasi.png";
    statusTextLogin.textContent = "Online";
    statusTextLogin.style.color = "green";
  } else if (type === "error") {
    statusImageLogin.src = "match_locked_icon.png";
    statusTextLogin.textContent = "Error";
    statusTextLogin.style.color = "orange";
  } else {
    statusImageLogin.src = "notifikasi.png";
    statusTextLogin.textContent = "Offline";
    statusTextLogin.style.color = "red";
  }

  statusMessageLogin.textContent = message;

  // ‚úÖ Semua status (online, error, offline) hilang setelah 3 detik
  setTimeout(() => {
    statusBoxLogin.style.display = "none";
  }, 4000);
}

// ‚úÖ Tampilkan status logout
function setLogoutStatus(message = "") {
  statusBoxLogout.style.display = "block";
  statusImageLogout.src = "match_locked_icon.png";
  statusTextLogout.textContent = "Logout";
  statusTextLogout.style.color = "red";
  statusMessageLogout.textContent = message;

  setTimeout(() => statusBoxLogout.style.display = "none", 3000);
}

// ‚úÖ Cek Status Login Saat Halaman Dibuka
if (localStorage.getItem("isLoggedIn") === "true") {
  showDashboard();
  setLoginStatus("online", "Anda sedang login.");
} else {
  showLogin();
  setLoginStatus("offline", "Silakan login untuk melanjutkan.");
}

// ‚úÖ Fungsi Tampilkan Dashboard
function showDashboard() {
  loginPage.style.display = "none";
  dashboard.style.display = "block";
}

// ‚úÖ Fungsi Tampilkan Login
function showLogin() {
  loginPage.style.display = "flex";
  dashboard.style.display = "none";
}

// ‚úÖ Event Login
loginBtn.addEventListener("click", function () {
  const email = document.getElementById("adminEmail").value;
  const pin = document.getElementById("adminPin").value;

  if (email === ADMIN_EMAIL && pin === ADMIN_PIN) {
    localStorage.setItem("isLoggedIn", "true");
    showDashboard();
    setLoginStatus("online", "Login berhasil!");
  } else {
    setLoginStatus("error", "Email atau PIN salah!");
  }
});

// ‚úÖ Event Logout
logoutBtn.addEventListener("click", function () {
  localStorage.removeItem("isLoggedIn");
  showLogin();
  setLogoutStatus("Anda telah logout.");
});



function showPage(pageId) {
  // Sembunyikan semua page
  const pages = document.querySelectorAll('.page, #saldoHostAdmin, #tambahCreditSection, #kelolaCoinSection, #updateTagihan');
  pages.forEach(page => page.style.display = 'none');

  // Tampilkan page yang diinginkan
  const selectedPage = document.getElementById(pageId);
  if(selectedPage) selectedPage.style.display = 'block';
}




 function showUserInfo() {
    const select = document.getElementById('admin-selectUser');
    const info = document.getElementById('admin-userInfo');
    if (select.value) {
      info.style.display = 'block';
      document.getElementById('admin-selectedUserId').innerText = select.value;
      document.getElementById('admin-selectedUserName').innerText = "Nama User " + select.value;
    } else {
      info.style.display = 'none';
    }
  }




function showPage(pageId) {
  // ambil semua elemen dengan class "page"
  const pages = document.querySelectorAll(".page");

  // sembunyikan semua
  pages.forEach(p => p.style.display = "none");

  // tampilkan hanya halaman yang dipilih
  const target = document.getElementById(pageId);
  if (target) target.style.display = "block";
}








</script>

</body>
</html>
